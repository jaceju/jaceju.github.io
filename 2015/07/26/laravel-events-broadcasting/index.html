<!doctype html>
<html class="theme-next use-motion ">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>




  <meta name="keywords" content="Laravel,PHP," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    analytics: {
      google: 'UA-450710-8'
    },
    sidebar: 'post'
  };
</script>




  <title> Laravel 5.1 Events Broadcasting 實務練習 // 網站製作學習誌 </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">網站製作學習誌</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首頁
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          歸檔
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          標籤
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              Laravel 5.1 Events Broadcasting 實務練習
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2015-07-26
        </span>

        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/26/laravel-events-broadcasting/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/07/26/laravel-events-broadcasting/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <p>Laravel 5.1 提供了一個非常棒的 Events Broadcasting 特色，它能讓開發者建立一個 RealTime Web App 。作者 Taylor 也錄製了一個 Events Broadcasting 的<a href="https://laracasts.com/lessons/broadcasting-events-in-laravel-5-1" target="_blank" rel="external">教學影片</a>，讓開發者可以更快瞭解這個新功能。</p>
<p>教學影片中雖然是使用 <a href="https://pusher.com/" target="_blank" rel="external">Pusher</a> 服務來做事件推送，不過 Laravel 也可以搭配 <a href="http://redis.io/" target="_blank" rel="external">Redis</a> 來做到同樣的事情。考量到未來的系統發展，我打算採用 Redis 來當做事件推送伺服器，所以本文也會在此基礎進行說明。</p>
<p>以下就來介紹如何用 Laravel 的 Events Broadcasting 來實作一個簡單的聊天室。</p>
<a id="more"></a>
<h2 id="原理">原理</h2><p>簡單說明一下本文的實作原理：</p>
<ol>
<li>啟動 Redis 伺服器來監聽 Laravel 發送出來的事件。</li>
<li>透過 Node Express 建立一個 Socket.IO Server ，並且接收 Redis Server 推送過來的事件，然後將它廣播到 WebSocket 上。</li>
<li>瀏覽器上建立與 Socket.IO Server 的連結，透過 WebSocket 接收事件來完成即時互動。</li>
</ol>
<h2 id="開發環境">開發環境</h2><p>Laravel 官方推薦開發者使用 Homestead ，原因是它已經幫我們安裝好所有 Laravel 需要的執行環境，例如 Redis 與 Node.js 。在繼續下去之前，請先依照<a href="http://laravel.com/docs/5.1/homestead" target="_blank" rel="external">官方說明</a> (<a href="http://laravel.tw/docs/5.1/homestead" target="_blank" rel="external">中文版</a>) 將 Homestead 安裝好。</p>
<p>然後利用 <code>homestead edit</code> 打開 Homestead 的設定檔：</p>
<blockquote>
<p>註：以下指令中，開頭的 <code>$</code> 為系統提示符號，不用輸入。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ homestead edit</span><br></pre></td></tr></table></figure>
<p>確認本機路徑 <code>~/Projects</code> 有正確 mount 到 Homestead 的 <code>/home/vagrant/Projects</code> 上。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">folders:&#10;    - map: ~/Projects&#10;      to: /home/vagrant/Projects</span><br></pre></td></tr></table></figure>
<p>要連上 Homestead 裡的虛擬站台 (Virtual Host) ，必須要讓本機認得專案對應的 hostname 。所以要編輯本機的 <code>/etc/hosts</code> ，加入 IP 與 hostname 的對應：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">192.168.10.10 chat-room.app</span><br></pre></td></tr></table></figure>
<p><code>192.168.10.10</code> 是在 Homestead.yml 中設定的 IP 。</p>
<p>啟動 Homestead ，並用 ssh 連入 Homestead ：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ homestead up</span><br><span class="line">$ homestead ssh</span><br></pre></td></tr></table></figure>
<p>檢查 node.js 版本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ node -v</span><br><span class="line">v1.<span class="number">8.1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>註： Homestead 是透過 nvm 安裝 io.js ，所以可以自行升級 io.js 到最新版。</p>
</blockquote>
<p>檢查 redis 是否啟動：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ redis-cli ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure>
<p>新增一個虛擬站台：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ serve chat-room.app ~/Projects/chat-room/public</span><br></pre></td></tr></table></figure>
<h2 id="建立應用程式">建立應用程式</h2><p>在 Homestead 中，利用 composer 來下載已經設定好的 Laravel 5.1 Boilerplate ，執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/Projects</span><br><span class="line">$ composer create-project jaceju/b5 chat-room <span class="operator">-s</span> dev</span><br></pre></td></tr></table></figure>
<p>程式就會開始下載並進行安裝。完成後進入專案資料夾，以便進行後續操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> chat-room</span><br></pre></td></tr></table></figure>
<h3 id="調整_gulpfile-js">調整 gulpfile.js</h3><p>在 Homestead 上開發時，不需要啟動 Web Server ，因此要調整 <code>gulpfile.js</code> 。</p>
<p>編輯 <code>gulpfile.js</code> ，把 <code>port</code> 變數與 <code>serve</code> task 移除，並將 <code>proxy</code> 改到 <code>chat-room.app</code> ，完成後如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ... (略)</span></span><br><span class="line"></span><br><span class="line">elixir(<span class="function"><span class="keyword">function</span> (<span class="params">mix</span>) </span>&#123;</span><br><span class="line">    mix.clean()</span><br><span class="line">        .sass(<span class="string">'*.scss'</span>)</span><br><span class="line">        .wiredep()</span><br><span class="line">        .jshint()</span><br><span class="line">        .sync(<span class="string">'resources/assets/js/**/*.js'</span>, <span class="string">'public/js'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (elixir.config.production) &#123;</span><br><span class="line">        mix.useref(&#123; src: <span class="literal">false</span> &#125;)</span><br><span class="line">            .version([<span class="string">'js/*.js'</span>, <span class="string">'css/*.css'</span>])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="安裝必要套件">安裝必要套件</h2><p>Laravel 操作 Redis 是透過 <a href="https://github.com/nrk/predis" target="_blank" rel="external">Predis</a> 套件，所以我們要透過 composer 安裝：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require predis/predis</span><br></pre></td></tr></table></figure>
<p>接下來要透過 Npm 與 Bower 安裝 Socket.IO Server 相關套件，包含前後端：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install express ioredis socket.io --save</span><br><span class="line">$ bower install socket.io-client --save</span><br></pre></td></tr></table></figure>
<h2 id="建立_Socket-IO_Server">建立 Socket.IO Server</h2><p>接下來要利用 Node.js 的 express 和 http 模組建立一個 Web Server ，然後讓 Socket.IO 透過這個 WebServer 來廣播從 Redis 接收到的事件。先建立 <code>socket.js</code> ，內容為：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'express'</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>).Server(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(http);</span><br><span class="line"><span class="keyword">var</span> Redis = <span class="built_in">require</span>(<span class="string">'ioredis'</span>);</span><br><span class="line"><span class="keyword">var</span> redis = <span class="keyword">new</span> Redis();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Redis 訂閱 `chat-channel` 頻道</span></span><br><span class="line">redis.subscribe(<span class="string">'chat-channel'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, count</span>) </span>&#123;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 當 Redis 有事件發生時，透過 Socket.IO Server 發送事件</span></span><br><span class="line">redis.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">channel, message</span>) </span>&#123;</span><br><span class="line">    message = <span class="built_in">JSON</span>.parse(message);</span><br><span class="line">    io.emit(channel + <span class="string">':'</span> + message.event, message.data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 讓用戶端可以透過 Port 3000 連接 Socket.IO Server</span></span><br><span class="line">http.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Listening on Port 3000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然後在 Homestead 上啟動 Socket.IO Server ：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ node socket.js &amp;</span><br><span class="line">Listening on Port <span class="number">3000</span></span><br></pre></td></tr></table></figure>
<h2 id="修改設定">修改設定</h2><p>Laravel 5.1 預設是使用 Pusher 做為事件推送伺服器，可以在 <code>config/broadcasting.php</code> 裡看到這個設定：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">'default'</span> =&gt; env(<span class="string">'BROADCAST_DRIVER'</span>, <span class="string">'pusher'</span>),</span><br></pre></td></tr></table></figure>
<p>因為這裡使用了 <code>env</code> 函式，所以我們可以編輯 <code>.env</code> ，加入以下設定來改用 Redis 伺服器：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="setting">BROADCAST_DRIVER=<span class="value">redis</span></span></span><br></pre></td></tr></table></figure>
<h2 id="建立_Event_類別">建立 Event 類別</h2><p>接下來就要讓 Laravel 能夠發送事件了，在 Laravel 5.0 以後的版本提供了 <code>make:event</code> 這個指令可以協助我們建立 Event 類別。首先我們的聊天室需要一個「訊息被建立」的事件，所以執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ php artisan make:event MessageCreated</span><br></pre></td></tr></table></figure>
<p>這樣就會建立 <code>app/Events/MessageCreated.php</code> 。</p>
<p>接著我們要讓 <code>MessageCreated</code> 類別能夠被 Redis 推送，所以編輯 <code>app/Events/MessageCreated.php</code> ，讓它實作 <code>Illuminate\Contracts\Broadcasting\ShouldBroadcast</code> 介面。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Broadcasting</span>\<span class="title">ShouldBroadcast</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageCreated</span> <span class="keyword">extends</span> <span class="title">Event</span> <span class="keyword">implements</span> <span class="title">ShouldBroadcast</span></span></span><br></pre></td></tr></table></figure>
<p>在推送事件時，我們可以附帶一組要傳送的資料，稱為 payload 。通常我們會在 Event 類別的建構子中帶入 payload 。修改 <code>MessageCreated</code> 類別，加入 <code>$username</code> 與 <code>$message</code> 屬性，並在建構子中注入：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="variable">$username</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="variable">$message</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(<span class="variable">$username</span>, <span class="variable">$message</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">    <span class="variable">$this</span>-&gt;message = <span class="variable">$message</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接著我們要讓它能在推送事件時，把這兩個屬性一起傳送出去；主要是透過 <code>broadcastWith</code> 這個方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastWith</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'username'</span> =&gt; <span class="variable">$this</span>-&gt;username,</span><br><span class="line">        <span class="string">'message'</span> =&gt; <span class="variable">$this</span>-&gt;message,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最後我們需要一個頻道來廣播事件，這是因為要讓 Redis 可以識別要廣播的對象。我們可以在 <code>broadcastOn</code> 方法回傳 Redis 訂閱的頻道名稱，即為前面指定的 <code>chat-channel</code> ：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastOn</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">'chat-channel'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>註：一個事件可以廣播給數個頻道，所以這裡要回傳一個陣列。</p>
</blockquote>
<p>完成後的程式碼如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Events</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Broadcasting</span>\<span class="title">ShouldBroadcast</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageCreated</span> <span class="keyword">extends</span> <span class="title">Event</span> <span class="keyword">implements</span> <span class="title">ShouldBroadcast</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$message</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(<span class="variable">$username</span>, <span class="variable">$message</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;message = <span class="variable">$message</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastWith</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'username'</span> =&gt; <span class="variable">$this</span>-&gt;username,</span><br><span class="line">            <span class="string">'message'</span> =&gt; <span class="variable">$this</span>-&gt;message,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastOn</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'chat-channel'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="建立_Routes_與_Controller">建立 Routes 與 Controller</h2><p>這裡我們只需要兩個 route ：聊天室頁面，以及發送訊息。改寫 <code>app/Http/routes.php</code> ，內容如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line">get(<span class="string">'/'</span>, <span class="string">'ChatController@index'</span>); <span class="comment">// 聊天室頁面</span></span><br><span class="line">post(<span class="string">'send-message'</span>, <span class="string">'ChatController@sendMessage'</span>); <span class="comment">// 發送訊息</span></span><br></pre></td></tr></table></figure>
<p>然後要建立 <code>ChatController</code> 來處理程式流程，在 Terminal 中執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ php artisan make:controller ChatController --plain</span><br></pre></td></tr></table></figure>
<p>編輯新建立的 <code>app/Http/Controllers/ChatController.php</code> ，先加入 <code>index</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    srand(time()); <span class="comment">// 亂數種子</span></span><br><span class="line">    <span class="variable">$username</span> = sprintf(<span class="string">'user%06d'</span>, rand(<span class="number">1</span>, <span class="number">100000</span>)); <span class="comment">// 決定 user 名稱 (註)</span></span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'chat'</span>, compact(<span class="string">'username'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>index</code> 方法中，主要是產生一個隨機的使用者名稱，並顯示在首頁樣版裡。</p>
<blockquote>
<p>註：這裡產生 <code>username</code> 的方法並不嚴謹，沒有考慮到名稱重複的問題，但現階段先暫時這樣。</p>
</blockquote>
<p>接下來我們要接收使用者建立的訊息，然後發送一個「訊息被建立」的事件，所以新增 <code>sendMessage</code> 方法，內容為：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">(Request <span class="variable">$request</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$request</span>-&gt;get(<span class="string">'username'</span>);</span><br><span class="line">    <span class="variable">$message</span> = <span class="variable">$request</span>-&gt;get(<span class="string">'message'</span>);</span><br><span class="line">    event(<span class="keyword">new</span> MessageCreated(<span class="variable">$username</span>, <span class="variable">$message</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'message sent'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="建立樣版頁面">建立樣版頁面</h2><p>切換到前端開發模式，我們要修改一下介面的呈現。</p>
<p>先處理 HTML 的部份，將原來的 <code>resources/views/welcome.blade.php</code> 重新命名為 <code>resources/views/chat.blade.php</code> ，將 <code>div.container</code> 的內容修改如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"col-md-6 col-md-offset-3"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Chat Room Demo<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 訊息列表框 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"chat-room"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 輸入訊息的表單 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">form</span> <span class="attribute">id</span>=<span class="value">"send-message"</span> <span class="attribute">method</span>=<span class="value">"post"</span> <span class="attribute">action</span>=<span class="value">"/send-message"</span>&gt;</span></span><br><span class="line">                &#123;!! csrf_field() !!&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"hidden"</span> <span class="attribute">name</span>=<span class="value">"username"</span> <span class="attribute">value</span>=<span class="value">"&#123;&#123; $username &#125;&#125;"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"input-group"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">label</span> <span class="attribute">class</span>=<span class="value">"input-group-addon"</span>&gt;</span>&#123;&#123; $username &#125;&#125;<span class="tag">&lt;/<span class="title">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">input</span> <span class="attribute">id</span>=<span class="value">"message"</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">value</span>=<span class="value">""</span> <span class="attribute">class</span>=<span class="value">"form-control"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"input-group-btn"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="title">button</span> <span class="attribute">class</span>=<span class="value">"btn btn-success"</span> <span class="attribute">id</span>=<span class="value">"send"</span>&gt;</span>Send<span class="tag">&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="title">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>這樣會讓畫面上有一個訊息列表框以及一個輸入訊息的表單，如下圖所示。</p>
<p><img src="/resources/chat-room-demo/interface.png" alt="介面"></p>
<p>接下來稍微調整介面的樣式，編輯 <code>resources/assets/sass/app.scss</code> ，將內容修改如下：</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="at_rule">@<span class="keyword">import</span> <span class="string">"../../../public/bower_components/bootstrap-sass/assets/stylesheets/bootstrap"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">html</span>, <span class="tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">height</span><span class="value">: <span class="number">100%</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 訊息列表框</span></span><br><span class="line"><span class="id">#chat-room</span> &#123;</span><br><span class="line">  <span class="attribute">border</span><span class="value">: <span class="number">1px</span> solid <span class="hexcolor">#ccc</span>;</span></span><br><span class="line">  <span class="attribute">height</span><span class="value">: <span class="number">20rem</span>;</span></span><br><span class="line">  <span class="attribute">padding</span><span class="value">: <span class="number">1rem</span>;</span></span><br><span class="line">  <span class="attribute">overflow-x</span><span class="value">: hidden;</span></span><br><span class="line">  <span class="attribute">overflow-y</span><span class="value">: auto;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 單則訊息</span></span><br><span class="line">  <span class="class">.message</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span><span class="value">: <span class="number">1rem</span>;</span></span><br><span class="line">    <span class="attribute">margin-bottom</span><span class="value">: <span class="number">1rem</span>;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 輸入訊息的表單</span></span><br><span class="line"><span class="id">#send-message</span> &#123;</span><br><span class="line">  <span class="attribute">margin-top</span><span class="value">: -<span class="number">1px</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class">.input-group-addon</span> &#123;</span><br><span class="line">    <span class="attribute">border-top-left-radius</span><span class="value">: <span class="number">0</span>;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class">.input-group-btn</span> &gt; <span class="class">.btn</span> &#123;</span><br><span class="line">    <span class="attribute">border-top-right-radius</span><span class="value">: <span class="number">0</span>;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最後透過 JavaScript 讓所有東西串在一起，</p>
<p>編輯 <code>resources/assets/js/app.js</code> ，內容如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="pi">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> $chatRoom = $(<span class="string">'#chat-room'</span>);</span><br><span class="line"><span class="keyword">var</span> $sendMessage = $(<span class="string">'#send-message'</span>);</span><br><span class="line"><span class="keyword">var</span> $messageInput = $sendMessage.find(<span class="string">'input[name=message]'</span>);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">window</span>.io;</span><br><span class="line"><span class="keyword">var</span> socket = io(<span class="string">'http://chat-room.app:3000'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 當送出表單時，改用 Ajax 傳送，並清空輸入框。</span></span><br><span class="line">$sendMessage.on(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.post(<span class="keyword">this</span>.action, $sendMessage.serialize());</span><br><span class="line">    $messageInput.val(<span class="string">''</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 當接收到訊息建立的事件時，將接收到的 payload</span></span><br><span class="line">socket.on(<span class="string">'chat-channel:App\\Events\\MessageCreated'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">payload</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> html = <span class="string">'&lt;div class="message alert-info" style="display: none;"&gt;'</span>;</span><br><span class="line">    html += payload.username + <span class="string">': '</span>;</span><br><span class="line">    html += payload.message;</span><br><span class="line">    html += <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> $message = $(html);</span><br><span class="line">    $chatRoom.append($message);</span><br><span class="line">    $message.fadeIn(<span class="string">'fast'</span>);</span><br><span class="line">    $chatRoom.animate(&#123;scrollTop: $chatRoom[<span class="number">0</span>].scrollHeight&#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="執行測試">執行測試</h2><p>在 Homestead 上執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gulp</span><br></pre></td></tr></table></figure>
<p>然後在本機分別開啟兩個瀏覽器視窗瀏覽 <code>http://chat-room.app</code> ，然後在輸出框上輸入文字後按 <code>Send</code> ，應該就會讓兩個瀏覽器同時出現相同的文字。</p>
<p><img src="/resources/chat-room-demo/in-use.png" alt="展示"></p>
<h2 id="結論">結論</h2><p>當然這個 Demo 並無法真正在實務上使用，因為還有很多地方要考慮，例如訊息歷史，使用者登入等等。不過這已經足夠讓我們瞭解 Laravel 5.1 在實作 Broadcasting 時有多麼輕鬆，除了執行環境之外，程式也沒有太多複雜的流程。</p>
<p>讓我們更容易在專案前期就先實現很多想法。</p>
<h2 id="參考">參考</h2><ul>
<li><a href="https://laracasts.com/discuss/channels/general-discussion/step-by-step-guide-to-installing-socketio-and-broadcasting-events-with-laravel-51" target="_blank" rel="external">Step by Step Guide to Installing Socket.io and Broadcasting Events with Laravel 5.1 </a></li>
</ul>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Laravel/"> #Laravel </a>
          
            <a href="/tags/PHP/"> #PHP </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/07/08/front-end-framework-survey/">front-end framework survey</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="comments" id="comments">
        
          <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          </div>
        
      </div>
    
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Jace Ju" />
          <p class="site-author-name">Jace Ju</p>
        </div>
        <p class="site-description motion-element"></p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">583</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">50</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/jaceju" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://twitter.com/jaceju" target="_blank">Twitter</a>
            </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#原理"><span class="nav-number">1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#開發環境"><span class="nav-number">2.</span> <span class="nav-text">開發環境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立應用程式"><span class="nav-number">3.</span> <span class="nav-text">建立應用程式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#調整_gulpfile-js"><span class="nav-number">3.1.</span> <span class="nav-text">調整 gulpfile.js</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安裝必要套件"><span class="nav-number">4.</span> <span class="nav-text">安裝必要套件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立_Socket-IO_Server"><span class="nav-number">5.</span> <span class="nav-text">建立 Socket.IO Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改設定"><span class="nav-number">6.</span> <span class="nav-text">修改設定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立_Event_類別"><span class="nav-number">7.</span> <span class="nav-text">建立 Event 類別</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立_Routes_與_Controller"><span class="nav-number">8.</span> <span class="nav-text">建立 Routes 與 Controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立樣版頁面"><span class="nav-number">9.</span> <span class="nav-text">建立樣版頁面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#執行測試"><span class="nav-number">10.</span> <span class="nav-text">執行測試</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#結論"><span class="nav-number">11.</span> <span class="nav-text">結論</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#參考"><span class="nav-number">12.</span> <span class="nav-text">參考</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Jace Ju</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js"></script>


  <script type="text/javascript" src="/js/helpers.js"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js" id="motion.global"></script>




  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if (isDesktop() && CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    });
  </script>




  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  
  

  

    
      
    

    <script type="text/javascript">
      var disqus_shortname = 'jaceju';
      var disqus_identifier = '2015/07/26/laravel-events-broadcasting/';
      var disqus_title = 'Laravel 5.1 Events Broadcasting 實務練習';
      var disqus_url = 'http://jaceju.net/2015/07/26/laravel-events-broadcasting/';

      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>
  




  
  
  <script type="text/javascript" src="/js/analytics_google-analytics.js"></script>


</body>
</html>
