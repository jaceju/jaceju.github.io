<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ASP 購物車三部曲(1) | 網站製作學習誌</title>
  <meta name="author" content="Jace Ju">
  
  <meta name="description" content="簡介物件導向是一種思維，這點我深信不疑。但是在我寫了 ASP 物件設計手法系列文章後，我才發現自己其實深陷在語言的泥淖裡。 
我想這裡也許該用一些真正的實例來表達我的想法了，也就是我想告訴大家，我心目中的物件導向思維到底是什麼？
前面幾篇的 ASP 物件設計手法或許看起來很神妙，但那只不過是 ASP 原本就有的一些東西。在別的物件導向語言裡，這些手法可能就像呼吸一樣稀鬆平常。所以如果你懂的是別種開發平台 (例如 PHP 、 ASP.NET 或 JSP ) 也沒關係，瞭解物件導向思維的意義後，你大可去發揮那個平台的長處。
當然不一定非得 ASP 不可，我已經不會再去證明 ASP 能不能辦到什麼。只不過我想會寫 Web 網站程式的人大部份應該都懂 ASP ，而且也為了延續之前的主題，所以這裡就繼續用 ASP 了。
註：這裡的 ASP 採用的當然是 VBScript ，你想用 JScript 來做我也不反對。
我將利用一個簡化的購物車程式，來介紹一些我設計購物車程式時的概念，其中會包括先前介紹的 ASP 物件設計手法以及設計模式的應用。
廢話不多說，往下看吧。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="ASP 購物車三部曲(1)"/>
  <meta property="og:site_name" content="網站製作學習誌"/>

  
    <meta property="og:image" content="http://i.imgur.com/LmHuRXl.jpg"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="網站製作學習誌" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">網站製作學習誌</a></h1>
  <h2><a href="/">記錄在開發網站時所學的一切</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2006-04-22T16:00:00.000Z"><a href="/2006/04/23/96/">2006-04-23</a></time>
      
      
  
    <h1 class="title">ASP 購物車三部曲(1)</h1>
  

    </header>
    <div class="entry">
      
        <h2 id="簡介">簡介</h2><p>物件導向是一種思維，這點我深信不疑。但是在我寫了 ASP 物件設計手法系列文章後，我才發現自己其實深陷在語言的泥淖裡。 </p>
<p>我想這裡也許該用一些真正的實例來表達我的想法了，也就是我想告訴大家，我心目中的物件導向思維到底是什麼？</p>
<p>前面幾篇的 ASP 物件設計手法或許看起來很神妙，但那只不過是 ASP 原本就有的一些東西。在別的物件導向語言裡，這些手法可能就像呼吸一樣稀鬆平常。所以如果你懂的是別種開發平台 (例如 PHP 、 ASP.NET 或 JSP ) 也沒關係，瞭解物件導向思維的意義後，你大可去發揮那個平台的長處。</p>
<p>當然不一定非得 ASP 不可，我已經不會再去證明 ASP 能不能辦到什麼。只不過我想會寫 Web 網站程式的人大部份應該都懂 ASP ，而且也為了延續之前的主題，所以這裡就繼續用 ASP 了。</p>
<p>註：這裡的 ASP 採用的當然是 VBScript ，你想用 JScript 來做我也不反對。</p>
<p>我將利用一個簡化的購物車程式，來介紹一些我設計購物車程式時的概念，其中會包括先前介紹的 ASP 物件設計手法以及設計模式的應用。</p>
<p>廢話不多說，往下看吧。</p>
<a id="more"></a>
<h2 id="購物車">購物車</h2><p>開發過稍具規模專案的程式設計師們，我想大部份都寫過購物車程式吧。購物車創造了多少台灣經濟奇蹟我是不清楚，但是至少它一直是網站開發的重要課題之一。</p>
<p>其實購物車的本意很簡單，也就是在使用者瀏覽網站的過程裡，將他所選擇的商品資訊放到記憶體或資料庫中，最後再提供一個畫面顯示他買過哪些東西。</p>
<p>註：也許有人會說購物車應該還有金流物流等機制，不過這裡我想就先略過不提了。我們先把焦點放在最單純的購物車機制上，將基礎打好後再往下繼續。</p>
<h3 id="加入購物車">加入購物車</h3><p>在物件導向的思維裡，我們習慣把購物車視成一個物件，而商品當然也是一個一個的物件，這其實和現實生活沒什麼兩樣。把喜歡的商品放到購物車裡，這種動作再自然也不過。當然在程式的世界裡，我們很少會去完整模擬出購物車和商品的樣子 (是誰說網站購物車要有輪子的？) 我們只會把購物車所要具備的功能實作出來而已。</p>
<p>想像一下，你可能會把三包科學麵、兩瓶可樂還有一盒巧克力放到你的購物車裡。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Set oCart = New Shopping_Cart&#10;oCart.AddCartItem &#34;&#31185;&#23416;&#40629;&#34;, 3&#10;oCart.AddCartItem &#34;&#29942;&#35037;&#21487;&#27138;&#34;, 2&#10;oCart.AddCartItem &#34;&#30418;&#35037;&#24039;&#20811;&#21147;&#34;, 1</span><br></pre></td></tr></table></figure>
<p>在 AddCartItem 中，第一個參數表示商品代碼 (只是這裡我用商品名稱) ，後面則是購買數量。</p>
<p>但是，在較大規模的網站上通常不會那麼簡單地採用這種設計。怎麼說呢？想想看，網站可能會有促銷活動，有些商品可能會有打折。總之你的客戶絕對不會這麼輕易把你晾在那邊，這時我們也許得先「預構」一下。</p>
<p>註：如果你不瞭「預構」那也沒關係，這無損客戶對你極盡壓榨之能事。</p>
<p>雖然我們不想過度設計，預先放入過多未來不確定的功能，但是基本應付變化的能力總是要有的。我在加入購物車時，多了一個商品種類的參數：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Set oCart = New Shopping_Cart&#10;oCart.AddCartItem &#34;&#31185;&#23416;&#40629;&#34;, 3, &#34;Normal&#34;&#10;oCart.AddCartItem &#34;&#29942;&#35037;&#21487;&#27138;&#34;, 2, &#34;Normal&#34;&#10;oCart.AddCartItem &#34;&#30418;&#35037;&#24039;&#20811;&#21147;&#34;, 1, &#34;Normal&#34;</span><br></pre></td></tr></table></figure>
<p>我為什麼要多出這個參數呢？其用意是什麼？商品種類是很有用的參數，因為有時候他可以告訴購物車，這是一個活動商品還是一般商品。</p>
<p>我知道你想問為什麼我知道會有這些變化，老實說，我一開始的時候也不知道。其實這些都是經由客戶的需求以及過往的經驗去整理出來的；如果客戶擺明未來有一陣子不可能會有這些東西，那就不值得你現在就把它們加上去。</p>
<p>現在看起來是能夠應付變化了，可是這樣好嗎？ AddCartItem 看起來參數太多了！</p>
<p>註：其實我也說不上來這種設計好不好，在我某個專案的第一版 (還存活著) 就是這麼做的。事實上我也許可以重構它，不過那時候我並沒有足夠的單元測試知識支援我做這種事情，所以我放棄了 (但至少維護起來沒那麼困難就是了) 。</p>
<p>這裡我們換個方式好了，我不打算讓 AddCartItem 想太多，畢竟如果以後有新的參數時， AddCartItem 的介面就很難改動，造成往後需要更多動作來處理。我乾脆直接讓 AddCartItem 接受一個購買項目物件好了，雖然在 ASP (VBScript) 裡實現起來有點難看，但在其他環境中我想可以很漂亮地完成。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Set oCart = New Shopping_Cart&#10;Set oP1 = New Shopping_CartItem : oP1.Init &#34;&#31185;&#23416;&#40629;&#34;, 3, &#34;Normal&#34;&#10;Set oP2 = New Shopping_CartItem : oP2.Init &#34;&#29942;&#35037;&#21487;&#27138;&#34;, 2, &#34;Normal&#34;&#10;Set oP3 = New Shopping_CartItem : oP3.Init &#34;&#30418;&#35037;&#24039;&#20811;&#21147;&#34;, 1, &#34;Normal&#34;&#10;oCart.AddCartItem oP1&#10;oCart.AddCartItem oP2&#10;oCart.AddCartItem oP3&#10;Set oP1 = Nothing&#10;Set oP2 = Nothing&#10;Set oP3 = Nothing</span><br></pre></td></tr></table></figure>
<p>其實我的想法應該是如此：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">oCart.AddCartItem(New Shopping_CartItem(&#34;&#31185;&#23416;&#40629;&#34;, 3, &#34;Normal&#34;))&#10;oCart.AddCartItem(New Shopping_CartItem(&#34;&#29942;&#35037;&#21487;&#27138;&#34;, 2, &#34;Normal&#34;))&#10;oCart.AddCartItem(New Shopping_CartItem(&#34;&#30418;&#35037;&#24039;&#20811;&#21147;&#34;, 1, &#34;Normal&#34;))</span><br></pre></td></tr></table></figure>
<p>當然這個程式是不能用的，因為 ASP (VBScript) 的建構式沒辦法傳參數進去，而且也不公開，所以就忘了它吧。</p>
<h3 id="更新購物車與取得總金額">更新購物車與取得總金額</h3><p>在將商品加入購物車時，我們並不會立刻去計算購物車的總金額，而是等到需要時再重新計算整個購物車內的購買項目所包含的價錢。</p>
<p>所以我在上面的測試程式的最後加上更新購物車的流程。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Set oCart = New Shopping_Cart&#10;Set oP1 = New Shopping_CartItem : oP1.Init &#34;&#31185;&#23416;&#40629;&#34;, 3, &#34;Normal&#34;&#10;Set oP2 = New Shopping_CartItem : oP2.Init &#34;&#29942;&#35037;&#21487;&#27138;&#34;, 2, &#34;Normal&#34;&#10;Set oP3 = New Shopping_CartItem : oP3.Init &#34;&#30418;&#35037;&#24039;&#20811;&#21147;&#34;, 1, &#34;Normal&#34;&#10;oCart.AddCartItem oP1&#10;oCart.AddCartItem oP2&#10;oCart.AddCartItem oP3&#10;Set oP1 = Nothing&#10;Set oP2 = Nothing&#10;Set oP3 = Nothing&#10;oCart.Update&#10;Response.Write oCart.GetAmount</span><br></pre></td></tr></table></figure>
<p>註：其實除了更新整個購物車以外，應該還要能單獨更新某個指定的商品或是清空購物車，不過我想這個就留給你自己去思考吧。</p>
<h3 id="寫出程式">寫出程式</h3><p>現在，我們就可以整理出 Shopping_Cart 類別應該要有什麼主要的功能：</p>
<ul>
<li>加入商品 (AddCartItem)</li>
<li>更新購物車 (Update)</li>
<li>取得總金額 (GetAmount) </li>
</ul>
<p>當然，在購物車內部我們應要會需要一個集合物件，用來存放購買項目，而 Dictionary 物件就是最適合的了。至於其他的功能是為了能讓測試能夠正常執行，我們暫時略過不提。</p>
<p>整個購物車的程式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;%&#10;&#39; /class/Shopping/Cart.asp&#10;&#39; &#36092;&#29289;&#36554;&#10;Class Shopping_Cart&#10;Private CartItemList&#10;Private Fields&#10;&#39; &#29289;&#20214;&#21021;&#22987;&#21270;&#10;Private Sub Class_Initialize()&#10;&#39; &#25105;&#20497;&#24314;&#31435;&#20102;&#19968;&#20491;&#23384;&#25918;&#36092;&#36023;&#38917;&#30446;&#30340; Dictionary &#29289;&#20214;&#10;&#39; &#20197;&#21450;&#19968;&#20491;&#23384;&#25918;&#36092;&#29289;&#36554;&#36039;&#35338;&#30340; Dictionary &#29289;&#20214;&#10;Set CartItemList = Server.CreateObject(&#34;Scripting.Dictionary&#34;)&#10;Set Fields = Server.CreateObject(&#34;Scripting.Dictionary&#34;)&#10;Fields.Add &#34;Amount&#34;, 0&#10;End Sub&#10;&#39; &#21152;&#20837;&#21830;&#21697;&#10;Public Sub AddCartItem(oCartItem)&#10;&#39; &#25105;&#20497;&#25226;&#21830;&#21697;&#21517;&#31281;&#30070;&#20570;&#32034;&#24341;&#37749;&#65292;&#23526;&#38555;&#19978;&#21063;&#26371;&#27604;&#36611;&#35079;&#38620;&#10;Dim sKey : sKey = oCartItem.GetField(&#34;Name&#34;)&#10;&#39; &#20808;&#21028;&#26039;&#26377;&#27794;&#26377;&#30456;&#21516;&#30340;&#21830;&#21697;&#23384;&#22312;&#10;If Not CartItemList.Exists(sKey) Then&#10;CartItemList.Add sKey, oCartItem&#10;&#39; &#24050;&#32147;&#23384;&#22312;&#23601;&#26356;&#25913;&#25976;&#37327;&#10;Else&#10;Dim oExistedCartItem&#10;Set oExistedCartItem = CartItemList(sKey)&#10;oExistedCartItem.SetField &#34;Quantity&#34;, _&#10;oExistedCartItem.GetField(&#34;Quantity&#34;) + _&#10;oCartItem.GetField(&#34;Quantity&#34;)&#10;End If&#10;End Sub&#10;&#39; &#21462;&#24471;&#25152;&#26377;&#21830;&#21697;&#10;Public Function Items()&#10;Items = CartItemList.Items&#10;End Function&#10;&#39; &#21028;&#26039;&#26159;&#21542;&#23384;&#22312;&#26576;&#20491;&#21830;&#21697;&#10;Public Function Exists(sKey)&#10;Exists = CartItemList.Exists(sKey)&#10;End Function&#10;&#39; &#26356;&#26032;&#36092;&#29289;&#36554;&#10;Public Sub Update()&#10;Dim oCartItem&#10;Fields(&#34;Amount&#34;) = 0&#10;For Each oCartItem In CartItemList.Items&#10;oCartItem.Refresh&#10;Fields(&#34;Amount&#34;) = Fields(&#34;Amount&#34;) + oCartItem.GetField(&#34;SubTotal&#34;)&#10;Next&#10;End Sub&#10;&#39; &#21462;&#24471;&#32317;&#37329;&#38989;&#10;Public Function GetAmount()&#10;GetAmount = Fields(&#34;Amount&#34;)&#10;End Function&#10;&#39; &#29289;&#20214;&#32080;&#26463;&#10;Private Sub Class_Terminate()&#10;Set CartItemList = Nothing&#10;Set Fields = Nothing&#10;End Sub&#10;End Class&#10;%&#62;</span><br></pre></td></tr></table></figure>
<p>如你所見，目前它只是個簡單的購物車，後面我們再來談談它會如何因應變化。</p>
<h2 id="購買項目">購買項目</h2><p>購買項目 (CartItem) 和商品 (Product) 是不一樣的概念，商品不會知道自己會屬於什麼活動，也不會知道購買數量的資訊。而購買項目主要是記錄消費者買了些什麼，並買了多少。</p>
<p>由於我們已經寫好了購物車類別，所以我們也能夠很清楚購買項目應該要提供什麼資訊給購物車。包括：</p>
<ul>
<li>初始化商品資料 (Init)</li>
<li>取得指定欄位 (GetField)</li>
<li>更新購買項目的小計金額 (Refresh) </li>
</ul>
<p>購買項目的程式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;%&#10;&#39; /class/Shopping/CartItem.asp&#10;Class Shopping_CartItem&#10;Private Fields&#10;Private Sub Class_Initialize()&#10;Set Fields = Server.CreateObject(&#34;Scripting.Dictionary&#34;)&#10;Fields.Add &#34;Price&#34;, 0&#10;Fields.Add &#34;Quantity&#34;, 0&#10;Fields.Add &#34;SubTotal&#34;, 0&#10;Fields.Add &#34;EventType&#34;, &#34;&#34;&#10;Fields.Add &#34;EventID&#34;, 0&#10;End Sub&#10;Private Sub Class_Terminate()&#10;Set Fields = Nothing&#10;End Sub&#10;Private Sub SetField(sName, vValue)&#10;If Fields.Exists(sName) Then&#10;Fields(sName) = vValue&#10;End If&#10;End Sub&#10;&#39; &#21021;&#22987;&#21270;&#21830;&#21697;&#36039;&#26009;&#10;Public Sub Init(sName, iQuantity, sEventType)&#10;Dim iPrice&#10;Dim oProduct&#10;Set oProduct = GetObject(&#34;Shopping_MockProduct&#34;)&#10;oProduct.Init sName&#10;&#39; &#24478;&#36039;&#26009;&#24235;&#21462;&#24471;&#36039;&#26009;&#10;If oProduct.Exists Then&#10;iPrice = oProduct.GetPrice&#10;SetField &#34;Price&#34;, iPrice&#10;SetField &#34;Quantity&#34;, iQuantity&#10;SetField &#34;SubTotal&#34;, iPrice * iQuantity&#10;SetField &#34;EventType&#34;, sEventType&#10;SetField &#34;EventID&#34;, iEventID&#10;End If&#10;End Sub&#10;&#39; &#21462;&#24471;&#25351;&#23450;&#27396;&#20301;&#36039;&#26009;&#10;Public Function GetField(sName)&#10;GetField = Null&#10;If Fields.Exists(sName) Then&#10;GetField = Fields(sName)&#10;End If&#10;End Function&#10;&#39; &#26356;&#26032;&#36092;&#36023;&#38917;&#30446;&#20839;&#23481;&#10;Public Sub Refresh()&#10;Fields(&#34;SubTotal&#34;) = Fields(&#34;Price&#34;) * Fields(&#34;Quantity&#34;)&#10;End Sub&#10;End Class&#10;%&#62;</span><br></pre></td></tr></table></figure>
<p>一般在購買項目初始化時，會從資料庫去取得商品的資料，不過這裡我為了簡化程式，就沒有實際去連結資料庫，而是把資料寫死 (<a href="http://en.wikipedia.org/wiki/Hard_code" target="_blank" rel="external">hard-code</a>) 在模擬用的商品類別裡。如果到時候真的要連結資料庫時，我只要抽換掉這個假的商品類別，換上會真正抓取資料庫的商品類別即可。</p>
<p>至於模擬用的商品類別 (MockProduct) 程式碼如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;%&#10;&#39; /class/Shopping/MockProduct.asp&#10;Class Shopping_MockProduct&#10;Private ProductData&#10;Private Name&#10;&#39; &#29289;&#20214;&#21855;&#21205;&#10;Private Sub Class_Initialize()&#10;Set ProductData = Server.CreateObject(&#34;Scripting.Dictionary&#34;)&#10;ProductData.Add &#34;&#31185;&#23416;&#40629;&#34;, 6&#10;ProductData.Add &#34;&#29942;&#35037;&#21487;&#27138;&#34;, 20&#10;ProductData.Add &#34;&#30418;&#35037;&#24039;&#20811;&#21147;&#34;, 100&#10;Name = &#34;&#34;&#10;End Sub&#10;&#39; &#29289;&#20214;&#32080;&#26463;&#10;Private Sub Class_Terminate()&#10;Set ProductData = Nothing&#10;End Sub&#10;&#39; &#21830;&#21697;&#21021;&#22987;&#21270;&#10;Public Sub Init(sName)&#10;Name = sName&#10;End Sub&#10;&#39; &#21830;&#21697;&#26159;&#21542;&#23384;&#22312;&#10;Public Function Exists()&#10;Exists = ProductData.Exists(Name)&#10;End Function&#10;&#39; &#21462;&#24471;&#20729;&#37666;&#10;Public Function GetPrice()&#10;GetPrice = ProductData(Name)&#10;End Function&#10;End Class&#10;%&#62;</span><br></pre></td></tr></table></figure>
<p>註：為了簡化程式篇幅，我拿掉了許多防呆程式碼。</p>
<p>現在整個程式的架構如下 (我簡略掉一些通用的函式及屬性) ：</p>
<p><img src="/resources/ooasp_cart/images/ooasp_cart_1_1.png" alt="原始購物車架構"></p>
<h2 id="新的購物模式">新的購物模式</h2><p>該來的還是會來，客戶總是不會讓我們過好日子的。我們接到了兩個新的需求，折扣活動與贈品活動。規格簡述如下：</p>
<ul>
<li>折扣活動：有部份商品可以有折扣，但是不能修改現有的商品資料，而是要在加入購物車時將金額自動抵扣掉。</li>
<li>贈品活動：如果消費者買了某個指定商品，那麼購物車要自動幫他加入附屬在這個商品下的贈品。</li>
</ul>
<p>註：別懷疑，這兩個行銷手法在實際的網站上是常見的，而且還算簡單，真正難搞的活動我還沒寫出來呢。</p>
<p>為了簡化說明，我把實作規格定義如下：</p>
<ul>
<li>折扣活動：有折扣的商品被歸類於 Discount 分類，而商品價格一律為 9 折。</li>
<li>贈品活動：當我們買了一瓶可樂後，購物車會自動幫我們加上一包科學麵。</li>
</ul>
<p>在贈品活動的部份，我希望贈品的價格是 0 ，所以在我 Shopping_MockProduct 類別初始化時加入了一個價格為 0 的「科學麵(贈品)」：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &#39; &#29289;&#20214;&#21855;&#21205;&#10;Private Sub Class_Initialize()&#10;Set ProductData = Server.CreateObject(&#34;Scripting.Dictionary&#34;)&#10;ProductData.Add &#34;&#31185;&#23416;&#40629;&#34;, 6&#10;ProductData.Add &#34;&#31185;&#23416;&#40629;(&#36104;&#21697;)&#34;, 0&#10;ProductData.Add &#34;&#29942;&#35037;&#21487;&#27138;&#34;, 20&#10;ProductData.Add &#34;&#30418;&#35037;&#24039;&#20811;&#21147;&#34;, 100&#10;Name = &#34;&#34;&#10;End Sub</span><br></pre></td></tr></table></figure>
<p>其實我希望除了這兩個活動以外，我的購物車能夠應付其他類型的活動，因此我在 AddCartItem 呼叫了一個函式，用來檢查商品所屬的活動，也就是說我把檢查的動作從 AddCartItem 中獨立出來：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &#39; &#21152;&#20837;&#21830;&#21697;&#10;Public Sub AddCartItem(oCartItem)&#10;&#39; &#25105;&#20497;&#25226;&#21830;&#21697;&#21517;&#31281;&#30070;&#20570;&#32034;&#24341;&#37749;&#65292;&#23526;&#38555;&#19978;&#21063;&#26371;&#27604;&#36611;&#35079;&#38620;&#10;Dim sKey : sKey = oCartItem.GetField(&#34;Name&#34;)&#10;&#39; &#20808;&#21028;&#26039;&#26377;&#27794;&#26377;&#30456;&#21516;&#30340;&#21830;&#21697;&#23384;&#22312;&#10;If Not CartItemList.Exists(sKey) Then&#10;CartItemList.Add sKey, oCartItem&#10;&#39; &#27298;&#26597;&#21830;&#21697;&#26159;&#21542;&#23660;&#26044;&#26576;&#20491;&#27963;&#21205;&#10;CheckCartItemForEvent oCartItem&#10;&#39; &#24050;&#32147;&#23384;&#22312;&#23601;&#26356;&#25913;&#25976;&#37327;&#10;Else&#10;Dim oExistedCartItem&#10;Set oExistedCartItem = CartItemList(sKey)&#10;oExistedCartItem.SetField &#34;Quantity&#34;, _&#10;oExistedCartItem.GetField(&#34;Quantity&#34;) + _&#10;oCartItem.GetField(&#34;Quantity&#34;)&#10;End If&#10;End Sub</span><br></pre></td></tr></table></figure>
<p>CheckCartItemForEvent 函式主要會判斷商品的活動型態，以處理對應的動作，其程式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &#39; &#27298;&#26597;&#26159;&#21542;&#28858;&#26576;&#20491;&#27963;&#21205;&#30340;&#21830;&#21697;&#10;Private Sub CheckCartItemForEvent(oCartItem)&#10;Select Case oCartItem.GetField(&#34;EventType&#34;)&#10;&#39; &#25240;&#25187;&#27963;&#21205;&#10;Case &#34;Discount&#34;&#10;oCartItem.SetField &#34;Price&#34;, oCartItem.GetField(&#34;Price&#34;) * 0.9&#10;oCartItem.Refresh&#10;&#39; &#36104;&#21697;&#27963;&#21205;&#10;Case &#34;Gift&#34;&#10;If &#34;&#29942;&#35037;&#21487;&#27138;&#34; = oCartItem.GetField(&#34;Name&#34;) Then&#10;Dim oGiftCartItem&#10;Set oGiftCartItem = GetObject(&#34;Shopping_CartItem&#34;)&#10;oGiftCartItem.Init &#34;&#31185;&#23416;&#40629;(&#36104;&#21697;)&#34;, 1, &#34;Normal&#34;&#10;AddCartItem oGiftCartItem&#10;End If&#10;&#39; &#19968;&#33324;&#21830;&#21697;&#65292;&#20160;&#40636;&#20063;&#19981;&#29992;&#20316;&#10;Case Else&#10;End Select&#10;End Sub</span><br></pre></td></tr></table></figure>
<p>因為 CheckCartItemForEvent 不會被外部呼叫，所以我用 Private 來指定它的存取權限。</p>
<h2 id="Strategy_模式">Strategy 模式</h2><p>雖然現在 CheckCartItemForEvent 函式看起來還不是很龐大，不過既然已經有三個不同的活動了 (一般商品也可歸屬為一種活動)，當然還會可能有第四個或第五個。可想而知未來 CheckCartItemForEvent 會逐漸變得落落長，超出我們所能理解的範圍。 </p>
<p>如果我們能把活動機制獨立在購物車外是不是比較好呢？這樣也能使得購物車不再背負過多的商業邏輯，在開發上也能靈活許多。</p>
<p>首先我定義一個虛假的活動類別好了，我們要在概念上繼承它 (就是 Duck Typing 啦) ，這個類別的定義如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;%&#10;Class Event&#10;&#39; &#34389;&#29702;&#36092;&#36023;&#38917;&#30446;&#10;Public Sub Check(oCartItem, oCart)&#10;End Sub&#10;End Class&#10;%&#62;</span><br></pre></td></tr></table></figure>
<p>在 Event 虛擬類別中，我們提供了一個 Check 函式，用來檢查即將要加入的商品 oCartItem 。不過為什麼還需要一個 oCart 參數呢？這是因為某些活動可能會需要購物車內的其他商品，所以我們就把購物車物件傳進來讓 Event 自行應用，稍後我們就能看到實際的例子。 </p>
<p>接著我建立一個處理一般商品的活動類別 Event_Normal，然而這個物件其實什麼也不做：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;%&#10;&#39; /class/Event/Normal.asp&#10;Class Event_Normal &#39; Extends Event&#10;&#39; &#34389;&#29702;&#36092;&#36023;&#38917;&#30446;&#10;Public Sub Check(oCartItem, oCart)&#10;End Sub&#10;End Class&#10;%&#62;</span><br></pre></td></tr></table></figure>
<p>當然我們還有兩種活動類別，先看看 Discount 好了，它比較簡單：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;%&#10;&#39; /class/Event/Discount.asp&#10;Class Event_Discount &#39; Extends Event&#10;&#39; &#34389;&#29702;&#36092;&#36023;&#38917;&#30446;&#10;Public Sub Check(oCartItem, oCart)&#10;oCartItem.SetField &#34;Price&#34;, oCartItem.GetField(&#34;Price&#34;) * 0.9&#10;oCartItem.Refresh&#10;End Sub&#10;End Class&#10;%&#62;</span><br></pre></td></tr></table></figure>
<p>你可以看到我用了一個很簡單的做法：把原來的值乘以 0.9 後，再將它設回 oCartItem 的單價裡。</p>
<p>註：注意！ ASP 的物件是以傳參考的方式來傳遞的，所以這邊只要一更新，就會直接反應回購物車內所對應的 CartItem 物件。 </p>
<p>剩下的 Gift 類別就比較複雜了，剛剛定義的 oCart 現在就派上用場了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;%&#10;&#39; /class/Event/Gift.asp&#10;Class Event_Gift &#39; Extends Event&#10;&#39; &#34389;&#29702;&#36092;&#36023;&#38917;&#30446;&#10;Public Sub Check(oCartItem, oCart)&#10;If &#34;&#29942;&#35037;&#21487;&#27138;&#34; = oCartItem.GetField(&#34;Name&#34;) Then&#10;Dim oGiftCartItem&#10;Set oGiftCartItem = GetObject(&#34;Shopping_CartItem&#34;) : oGiftCartItem.Init &#34;&#31185;&#23416;&#40629;(&#36104;&#21697;)&#34;, 1, &#34;Normal&#34;&#10;oCart.AddCartItem oGiftCartItem&#10;End If&#10;End Sub&#10;End Class&#10;%&#62;</span><br></pre></td></tr></table></figure>
<p>當 Event_Gift 發現 oCartItem 的 Name 是「瓶裝可樂」時，就會建立一個「科學麵(贈品)」的 CartItem 物件， 並利用 oCart 的 AddCartItem 把這個贈品再加上去。</p>
<p>好，現在三種活動類別都已經定義好了，我們就來看看怎麼用吧。</p>
<p>我把原來的 CheckCartItemForEvent 改成以下的形式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &#39; &#27298;&#26597;&#26159;&#21542;&#28858;&#26576;&#20491;&#27963;&#21205;&#30340;&#21830;&#21697;&#10;Private Sub CheckCartItemForEvent(oCartItem)&#10;Dim oEvent&#10;Select Case oCartItem.GetField(&#34;EventType&#34;)&#10;&#39; &#25240;&#25187;&#27963;&#21205;&#10;Case &#34;Discount&#34;&#10;        Set oEvent = GetObject(&#34;Event_Discount&#34;)&#10;&#39; &#36104;&#21697;&#27963;&#21205;&#10;Case &#34;Gift&#34;&#10;        Set oEvent = GetObject(&#34;Event_Gift&#34;)&#10;&#39; &#19968;&#33324;&#21830;&#21697;&#10;Case Else&#10;        Set oEvent = GetObject(&#34;Event_Normal&#34;)&#10;End Select&#10;    oEvent.Check oCartItem, Me&#10;End Sub</span><br></pre></td></tr></table></figure>
<p>發現什麼沒有？我們竟然可以用同樣的 Check 函式來檢查商品！這就是所謂的 Strategy 模式！</p>
<p> Strategy 模式主要的概念就是可抽換的策略，也就是在程式執行的階段裡，我們能用同一種操作方式 (如上面的 Check 函式) 來對資料進行不同的運算條件，而這些運算邏輯則定義在不同的策略類別裡，就像上面的 Event_xxx 類別。</p>
<p>在完整支援物件導向技術的語言中，這些策略類別應該是繼承自一個抽象類別或介面 (就是我們上面提到的虛擬 Event 類別) ，而 Event 的 Check 函式就是需要被實作的了。就因為 Event 類別所衍生的類別在實作上是不同的，所以我們才能用同一個 Check 函式來對應到不同的活動條件。</p>
<p>註：話說回來， ASP (VBScript) 既然沒有繼承，所以只要是有實作相同函式介面的類別所產生的實體，都有可能被拿來當做是策略物件。這點是 ASP (VBScript) 自由卻也是不合物件導向語言規範的地方。</p>
<p>另外注意一點，就是 Me 關鍵字的應用。我利用 Me 關鍵字把 CheckCartItemForEvent 所在這個物件 (也就是 Shopping_Cart 的實體) ，傳遞給 Event_xxx 物件，這樣這些 Event_xxx 物件就是利用 oCart 參數來存取目前的購物車內容。這種方式稱為 delegate (委託) ， Shopping_Cart 物件拜託 Event 物件做一些事情，所以要把自己 (Me) 託付給它。這在委託者缺少某些功能，而需要外部物件協助時非常有用。</p>
<p>和前面一樣，我簡單地把加入活動類別的架構圖描繪如下：</p>
<p><img src="/resources/ooasp_cart/images/ooasp_cart_1_2.png" alt="新的購物車架構"></p>
<h2 id="Factory_Method_模式">Factory Method 模式</h2><p>在上面的程式裡，我們還是在 CheckCartItemForEvent 函式中參雜了 Select Case 敘述，這使得我們到時候要新增活動時，還是得回來加上新的活動類別建構程式。有沒有什麼方法可以避免這些動作呢？或是直接拿掉 Select Case 敘述呢？</p>
<p>我相信大家也看出一些端倪了。我所用的類別代號 Normal 、 Gift 及 Discount ，其實就對應到 Event 的實作類別名稱。這表示我們能夠利用類別代號來產生我們所需要的物件，但是怎麼做呢？</p>
<p>從上面的程式裡，我們可以看到 GetObject 需要一個類別名稱來當做引數。這個引數剛好是用 Event_ 加上類別代碼，所以我們就能夠利用這點來下手。</p>
<p>我把剛剛的 Select Case 換成以下粗體的部份： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39; &#27298;&#26597;&#26159;&#21542;&#28858;&#26576;&#20491;&#27963;&#21205;&#30340;&#21830;&#21697;&#10;Private Sub CheckCartItemForEvent(oCartItem)&#10;Dim oEvent&#10;Set oEvent = CreateEvent(oCartItem.GetField(&#34;EventType&#34;))&#10;oEvent.Check oCartItem, Me&#10;End Sub</span><br></pre></td></tr></table></figure>
<p>現在我們就要思考 CreateEvent 函式要丟出什麼東西，以下是我的實作：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39; &#21462;&#24471;&#27963;&#21205;&#21830;&#21697;&#10;Private Function CreateEvent(sEventType)&#10;Set CreateEvent = Nothing&#10;On Error Resume Next&#10;Set CreateEvent = GetObject(&#34;Event_&#34; &#38;amp; sEventType)&#10;If CreateEvent Is Nothing Then&#10;  Set CreateEvent = GetObject(&#34;Event_Normal&#34;)&#10;End If&#10;On Error Goto 0&#10;End Function</span><br></pre></td></tr></table></figure>
<p>你可以看到我用之前介紹過的 Factory Method 手法來完成建構活動物件的過程，利用錯誤延遲機制讓不存在的活動類別一律視為一般商品來處理，避免掉一些不必要的麻煩。</p>
<p>Factory Method 最大的好處就是能夠隱藏物件建構的過程，讓呼叫它的程式能夠保持簡單及一致性。它可以把建構物件的複雜邏輯封裝在別的類別裡面，使得我們能夠重複使用這個類別來產生我們所要的東西，也就是能更簡單地把建構物件自動化。不過在這裡，你會發現到我並沒有再做出一個類別來放置 Factory Method ，為什麼呢？ </p>
<p>這要歸功於能把字串當做程式敘述的 Execute (ExecuteGlobal) 指令；在其他不支援此特性的語言裡，類似 Select Case 的敘述在 Factory Method 中通常是不可避免的；然而在 ASP (VBScript 、 JavaScript) 或 PHP 等語言平台中， Factory Method 因為這些語言支援把字串變成程式指令的特性，所以在實作上就變得更有彈性。</p>
<p>註：把字串當做程式敘述這種方式通常會有安全性上的議題出現，所以寫程式時要特別小心。</p>
<h2 id="結論">結論</h2><p>回頭思考看看，現在如果又有一個新的活動，我們已經不必再更改 Shopping_Cart 類別裡面的程式；只要新增一個 Event_xxx 類別，實作該活動的規則，就能讓購物車處理這些活動商品，這樣的彈性就是物件導向思維所帶來的好處。</p>
<p>也許你會想，這我用函式也能做到呀！其實也沒錯。不過這裡我要強調一件事，不管你用什麼方式開發，只要這些程式在你交接後還可能存活時，最後一定要考慮到程式的延展性。我採用物件導向思維及開發手法是為了更容易表達我對這個系統的概念，而且也讓整個系統就在物件交互作用之下，完成了許多看似複雜的工作。</p>
<p>另外我建議把這些開發的概念撰寫成文件，讓後續維護的人員能夠進入狀況，就像這篇文章一樣。他們不一定能夠清楚為什麼要採用這樣的方式，所以透過類似這篇文章的說明，他們就能一步一步瞭解開發者所建立的系統輪廓。</p>
<p>我希望透過我的介紹，能夠讓我的伙伴瞭解物件導向是怎麼一回事。而它到底是不是真的必須依賴語言？還是協助我們把心目中的系統架構描繪出來的一種設計手法？我想這邊就留給大家去思考，畢竟我不是大師，這種問題我無法解答；我能夠做的就是把這些概念實際轉換成程式碼，讓系統能夠順利運作而已。</p>
<h2 id="範例程式下載">範例程式下載</h2><p>範例程式不是個可用的購物車，它只包含了部份的商業邏輯而已，所以想要直接拿它來改寫的朋友可能會失望。不過裡面我用到了 ASPUnit ，有興趣學習如何撰寫單元測試的朋友可以參考看看。另外裡面包含了上面每個步驟所介紹的購物車原始程式，你可以參考壓縮檔案的 README.txt 來得知如何執行它們。 </p>
<p><a href="/resources/ooasp_cart/source/ooasp_01_src.rar">下載</a></p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/ASP/">ASP</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="http://jaceju.net/2006/04/23/96/index.html" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:jaceju.net">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/ASP/">ASP</a><small>8</small></li>
  
    <li><a href="/tags/AngularJS/">AngularJS</a><small>1</small></li>
  
    <li><a href="/tags/Backbone-js/">Backbone.js</a><small>2</small></li>
  
    <li><a href="/tags/CSS/">CSS</a><small>22</small></li>
  
    <li><a href="/tags/CoffeeScript/">CoffeeScript</a><small>1</small></li>
  
    <li><a href="/tags/Compass/">Compass</a><small>1</small></li>
  
    <li><a href="/tags/Grunt/">Grunt</a><small>1</small></li>
  
    <li><a href="/tags/IE6/">IE6</a><small>1</small></li>
  
    <li><a href="/tags/JSDC/">JSDC</a><small>1</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>46</small></li>
  
    <li><a href="/tags/Laravel/">Laravel</a><small>1</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>5</small></li>
  
    <li><a href="/tags/Mobile-開發/">Mobile 開發</a><small>1</small></li>
  
    <li><a href="/tags/MongoDB/">MongoDB</a><small>1</small></li>
  
    <li><a href="/tags/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/tags/NetBeans/">NetBeans</a><small>1</small></li>
  
    <li><a href="/tags/Octopress/">Octopress</a><small>1</small></li>
  
    <li><a href="/tags/PHP/">PHP</a><small>112</small></li>
  
    <li><a href="/tags/PHPConf-TW/">PHPConf.TW</a><small>1</small></li>
  
    <li><a href="/tags/RequireJS/">RequireJS</a><small>2</small></li>
  
    <li><a href="/tags/Selenium/">Selenium</a><small>2</small></li>
  
    <li><a href="/tags/Smarty/">Smarty</a><small>16</small></li>
  
    <li><a href="/tags/Software-Development/">Software Development</a><small>1</small></li>
  
    <li><a href="/tags/TDD/">TDD</a><small>3</small></li>
  
    <li><a href="/tags/Titanium/">Titanium</a><small>1</small></li>
  
    <li><a href="/tags/Web-開發/">Web 開發</a><small>25</small></li>
  
    <li><a href="/tags/WebConf/">WebConf</a><small>1</small></li>
  
    <li><a href="/tags/WebKit/">WebKit</a><small>1</small></li>
  
    <li><a href="/tags/Windows/">Windows</a><small>13</small></li>
  
    <li><a href="/tags/Yeoman/">Yeoman</a><small>1</small></li>
  
    <li><a href="/tags/Zend-Framework/">Zend Framework</a><small>57</small></li>
  
    <li><a href="/tags/jQuery/">jQuery</a><small>2</small></li>
  
    <li><a href="/tags/伺服器安裝與設定/">伺服器安裝與設定</a><small>18</small></li>
  
    <li><a href="/tags/作品/">作品</a><small>13</small></li>
  
    <li><a href="/tags/單元測試/">單元測試</a><small>4</small></li>
  
    <li><a href="/tags/好文推薦/">好文推薦</a><small>2</small></li>
  
    <li><a href="/tags/好書推薦/">好書推薦</a><small>14</small></li>
  
    <li><a href="/tags/好站推薦/">好站推薦</a><small>11</small></li>
  
    <li><a href="/tags/心得感想/">心得感想</a><small>34</small></li>
  
    <li><a href="/tags/持續整合/">持續整合</a><small>2</small></li>
  
    <li><a href="/tags/未分類/">未分類</a><small>5</small></li>
  
    <li><a href="/tags/業界資訊/">業界資訊</a><small>5</small></li>
  
    <li><a href="/tags/程式開發/">程式開發</a><small>14</small></li>
  
    <li><a href="/tags/網路趣味/">網路趣味</a><small>3</small></li>
  
    <li><a href="/tags/設計模式/">設計模式</a><small>7</small></li>
  
    <li><a href="/tags/資料庫/">資料庫</a><small>5</small></li>
  
    <li><a href="/tags/連結分享/">連結分享</a><small>183</small></li>
  
    <li><a href="/tags/開發工具/">開發工具</a><small>8</small></li>
  
    <li><a href="/tags/電腦知識/">電腦知識</a><small>7</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Jace Ju
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-450710-8', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>