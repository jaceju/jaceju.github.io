<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Laravel 5.1 Events Broadcasting 實務練習 | 網站製作學習誌</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Laravel 5.1 Events Broadcasting 實務練習</h1><a id="logo" href="/.">網站製作學習誌</a><p class="description">記錄在開發網站時所學的一切</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首頁</i></a><a href="/archives/"><i class="fa fa-archive"> 所有文章</i></a><a href="/about/"><i class="fa fa-user"> 關於</i></a><a href="/atom.xml"><i class="fa fa-rss"> 訂閱</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Laravel 5.1 Events Broadcasting 實務練習</h1><div class="post-meta">Jul 26, 2015</div><div class="post-content"><p>Laravel 5.1 提供了一個非常棒的 Events Broadcasting 特色，它能讓開發者建立一個 RealTime Web App 。作者 Taylor 也錄製了一個 Events Broadcasting 的<a href="https://laracasts.com/lessons/broadcasting-events-in-laravel-5-1" target="_blank" rel="noopener">教學影片</a>，讓開發者可以更快瞭解這個新功能。</p>
<p>教學影片中雖然是使用 <a href="https://pusher.com/" target="_blank" rel="noopener">Pusher</a> 服務來做事件推送，不過 Laravel 也可以搭配 <a href="http://redis.io/" target="_blank" rel="noopener">Redis</a> 來做到同樣的事情。考量到未來的系統發展，我打算採用 Redis 來當做事件推送伺服器，所以本文也會在此基礎進行說明。</p>
<p>以下就來介紹如何用 Laravel 的 Events Broadcasting 來實作一個簡單的聊天室。</p>
<a id="more"></a>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>簡單說明一下本文的實作原理：</p>
<ol>
<li>啟動 Redis 伺服器來監聽 Laravel 發送出來的事件。</li>
<li>透過 Node Express 建立一個 Socket.IO Server ，並且接收 Redis Server 推送過來的事件，然後將它廣播到 WebSocket 上。</li>
<li>瀏覽器上建立與 Socket.IO Server 的連結，透過 WebSocket 接收事件來完成即時互動。</li>
</ol>
<h2 id="開發環境"><a href="#開發環境" class="headerlink" title="開發環境"></a>開發環境</h2><p>Laravel 官方推薦開發者使用 Homestead ，原因是它已經幫我們安裝好所有 Laravel 需要的執行環境，例如 Redis 與 Node.js 。在繼續下去之前，請先依照<a href="http://laravel.com/docs/5.1/homestead" target="_blank" rel="noopener">官方說明</a> (<a href="http://laravel.tw/docs/5.1/homestead" target="_blank" rel="noopener">中文版</a>) 將 Homestead 安裝好。</p>
<p>然後利用 <code>homestead edit</code> 打開 Homestead 的設定檔：</p>
<blockquote>
<p>註：以下指令中，開頭的 <code>$</code> 為系統提示符號，不用輸入。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ homestead edit</span><br></pre></td></tr></table></figure>
<p>確認本機路徑 <code>~/Projects</code> 有正確 mount 到 Homestead 的 <code>/home/vagrant/Projects</code> 上。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">folders:</span></span><br><span class="line"><span class="attr">    - map:</span> <span class="string">~/Projects</span></span><br><span class="line"><span class="attr">      to:</span> <span class="string">/home/vagrant/Projects</span></span><br></pre></td></tr></table></figure>
<p>要連上 Homestead 裡的虛擬站台 (Virtual Host) ，必須要讓本機認得專案對應的 hostname 。所以要編輯本機的 <code>/etc/hosts</code> ，加入 IP 與 hostname 的對應：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">192.168.10.10 chat-room.app</span><br></pre></td></tr></table></figure>
<p><code>192.168.10.10</code> 是在 Homestead.yml 中設定的 IP 。</p>
<p>啟動 Homestead ，並用 ssh 連入 Homestead ：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ homestead up</span><br><span class="line">$ homestead ssh</span><br></pre></td></tr></table></figure>
<p>檢查 node.js 版本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ node -v</span><br><span class="line">v1.8.1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>註： Homestead 是透過 nvm 安裝 io.js ，所以可以自行升級 io.js 到最新版。</p>
</blockquote>
<p>檢查 redis 是否啟動：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ redis-cli ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure>
<p>新增一個虛擬站台：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ serve chat-room.app ~/Projects/chat-room/public</span><br></pre></td></tr></table></figure>
<h2 id="建立應用程式"><a href="#建立應用程式" class="headerlink" title="建立應用程式"></a>建立應用程式</h2><p>在 Homestead 中，利用 composer 來下載已經設定好的 Laravel 5.1 Boilerplate ，執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/Projects</span><br><span class="line">$ composer create-project jaceju/b5 chat-room -s dev</span><br></pre></td></tr></table></figure>
<p>程式就會開始下載並進行安裝。完成後進入專案資料夾，以便進行後續操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> chat-room</span><br></pre></td></tr></table></figure>
<h3 id="調整-gulpfile-js"><a href="#調整-gulpfile-js" class="headerlink" title="調整 gulpfile.js"></a>調整 gulpfile.js</h3><p>在 Homestead 上開發時，不需要啟動 Web Server ，因此要調整 <code>gulpfile.js</code> 。</p>
<p>編輯 <code>gulpfile.js</code> ，把 <code>port</code> 變數與 <code>serve</code> task 移除，並將 <code>proxy</code> 改到 <code>chat-room.app</code> ，完成後如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ... (略)</span></span><br><span class="line"></span><br><span class="line">elixir(<span class="function"><span class="keyword">function</span> (<span class="params">mix</span>) </span>&#123;</span><br><span class="line">    mix.clean()</span><br><span class="line">        .sass(<span class="string">'*.scss'</span>)</span><br><span class="line">        .wiredep()</span><br><span class="line">        .jshint()</span><br><span class="line">        .sync(<span class="string">'resources/assets/js/**/*.js'</span>, <span class="string">'public/js'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (elixir.config.production) &#123;</span><br><span class="line">        mix.useref(&#123; <span class="attr">src</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">            .version([<span class="string">'js/*.js'</span>, <span class="string">'css/*.css'</span>])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="安裝必要套件"><a href="#安裝必要套件" class="headerlink" title="安裝必要套件"></a>安裝必要套件</h2><p>Laravel 操作 Redis 是透過 <a href="https://github.com/nrk/predis" target="_blank" rel="noopener">Predis</a> 套件，所以我們要透過 composer 安裝：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer require predis/predis</span><br></pre></td></tr></table></figure>
<p>接下來要透過 Npm 與 Bower 安裝 Socket.IO Server 相關套件，包含前後端：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install express ioredis socket.io --save</span><br><span class="line">$ bower install socket.io-client --save</span><br></pre></td></tr></table></figure>
<h2 id="建立-Socket-IO-Server"><a href="#建立-Socket-IO-Server" class="headerlink" title="建立 Socket.IO Server"></a>建立 Socket.IO Server</h2><p>接下來要利用 Node.js 的 express 和 http 模組建立一個 Web Server ，然後讓 Socket.IO 透過這個 WebServer 來廣播從 Redis 接收到的事件。先建立 <code>socket.js</code> ，內容為：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'express'</span>)();</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>).Server(app);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(http);</span><br><span class="line"><span class="keyword">var</span> Redis = <span class="built_in">require</span>(<span class="string">'ioredis'</span>);</span><br><span class="line"><span class="keyword">var</span> redis = <span class="keyword">new</span> Redis();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Redis 訂閱 `chat-channel` 頻道</span></span><br><span class="line">redis.subscribe(<span class="string">'chat-channel'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, count</span>) </span>&#123;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 當 Redis 有事件發生時，透過 Socket.IO Server 發送事件</span></span><br><span class="line">redis.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">channel, message</span>) </span>&#123;</span><br><span class="line">    message = <span class="built_in">JSON</span>.parse(message);</span><br><span class="line">    io.emit(channel + <span class="string">':'</span> + message.event, message.data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 讓用戶端可以透過 Port 3000 連接 Socket.IO Server</span></span><br><span class="line">http.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Listening on Port 3000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>然後在 Homestead 上啟動 Socket.IO Server ：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ node socket.js &amp;</span><br><span class="line">Listening on Port 3000</span><br></pre></td></tr></table></figure>
<h2 id="修改設定"><a href="#修改設定" class="headerlink" title="修改設定"></a>修改設定</h2><p>Laravel 5.1 預設是使用 Pusher 做為事件推送伺服器，可以在 <code>config/broadcasting.php</code> 裡看到這個設定：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">'default'</span> =&gt; env(<span class="string">'BROADCAST_DRIVER'</span>, <span class="string">'pusher'</span>),</span><br></pre></td></tr></table></figure>
<p>因為這裡使用了 <code>env</code> 函式，所以我們可以編輯 <code>.env</code> ，加入以下設定來改用 Redis 伺服器：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">BROADCAST_DRIVER</span>=redis</span><br></pre></td></tr></table></figure>
<h2 id="建立-Event-類別"><a href="#建立-Event-類別" class="headerlink" title="建立 Event 類別"></a>建立 Event 類別</h2><p>接下來就要讓 Laravel 能夠發送事件了，在 Laravel 5.0 以後的版本提供了 <code>make:event</code> 這個指令可以協助我們建立 Event 類別。首先我們的聊天室需要一個「訊息被建立」的事件，所以執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ php artisan make:event MessageCreated</span><br></pre></td></tr></table></figure>
<p>這樣就會建立 <code>app/Events/MessageCreated.php</code> 。</p>
<p>接著我們要讓 <code>MessageCreated</code> 類別能夠被 Redis 推送，所以編輯 <code>app/Events/MessageCreated.php</code> ，讓它實作 <code>Illuminate\Contracts\Broadcasting\ShouldBroadcast</code> 介面。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Broadcasting</span>\<span class="title">ShouldBroadcast</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageCreated</span> <span class="keyword">extends</span> <span class="title">Event</span> <span class="keyword">implements</span> <span class="title">ShouldBroadcast</span></span></span><br></pre></td></tr></table></figure>
<p>在推送事件時，我們可以附帶一組要傳送的資料，稱為 payload 。通常我們會在 Event 類別的建構子中帶入 payload 。修改 <code>MessageCreated</code> 類別，加入 <code>$username</code> 與 <code>$message</code> 屬性，並在建構子中注入：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> $username;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> $message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($username, $message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;username = $username;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;message = $message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接著我們要讓它能在推送事件時，把這兩個屬性一起傳送出去；主要是透過 <code>broadcastWith</code> 這個方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastWith</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'username'</span> =&gt; <span class="keyword">$this</span>-&gt;username,</span><br><span class="line">        <span class="string">'message'</span> =&gt; <span class="keyword">$this</span>-&gt;message,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最後我們需要一個頻道來廣播事件，這是因為要讓 Redis 可以識別要廣播的對象。我們可以在 <code>broadcastOn</code> 方法回傳 Redis 訂閱的頻道名稱，即為前面指定的 <code>chat-channel</code> ：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">'chat-channel'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>註：一個事件可以廣播給數個頻道，所以這裡要回傳一個陣列。</p>
</blockquote>
<p>完成後的程式碼如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Events</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Broadcasting</span>\<span class="title">ShouldBroadcast</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageCreated</span> <span class="keyword">extends</span> <span class="title">Event</span> <span class="keyword">implements</span> <span class="title">ShouldBroadcast</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($username, $message)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = $username;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;message = $message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastWith</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'username'</span> =&gt; <span class="keyword">$this</span>-&gt;username,</span><br><span class="line">            <span class="string">'message'</span> =&gt; <span class="keyword">$this</span>-&gt;message,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'chat-channel'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="建立-Routes-與-Controller"><a href="#建立-Routes-與-Controller" class="headerlink" title="建立 Routes 與 Controller"></a>建立 Routes 與 Controller</h2><p>這裡我們只需要兩個 route ：聊天室頁面，以及發送訊息。改寫 <code>app/Http/routes.php</code> ，內容如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">get(<span class="string">'/'</span>, <span class="string">'ChatController@index'</span>); <span class="comment">// 聊天室頁面</span></span><br><span class="line">post(<span class="string">'send-message'</span>, <span class="string">'ChatController@sendMessage'</span>); <span class="comment">// 發送訊息</span></span><br></pre></td></tr></table></figure>
<p>然後要建立 <code>ChatController</code> 來處理程式流程，在 Terminal 中執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ php artisan make:controller ChatController --plain</span><br></pre></td></tr></table></figure>
<p>編輯新建立的 <code>app/Http/Controllers/ChatController.php</code> ，先加入 <code>index</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    srand(time()); <span class="comment">// 亂數種子</span></span><br><span class="line">    $username = sprintf(<span class="string">'user%06d'</span>, rand(<span class="number">1</span>, <span class="number">100000</span>)); <span class="comment">// 決定 user 名稱 (註)</span></span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">'chat'</span>, compact(<span class="string">'username'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>index</code> 方法中，主要是產生一個隨機的使用者名稱，並顯示在首頁樣版裡。</p>
<blockquote>
<p>註：這裡產生 <code>username</code> 的方法並不嚴謹，沒有考慮到名稱重複的問題，但現階段先暫時這樣。</p>
</blockquote>
<p>接下來我們要接收使用者建立的訊息，然後發送一個「訊息被建立」的事件，所以新增 <code>sendMessage</code> 方法，內容為：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $username = $request-&gt;get(<span class="string">'username'</span>);</span><br><span class="line">    $message = $request-&gt;get(<span class="string">'message'</span>);</span><br><span class="line">    event(<span class="keyword">new</span> MessageCreated($username, $message));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'message sent'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="建立樣版頁面"><a href="#建立樣版頁面" class="headerlink" title="建立樣版頁面"></a>建立樣版頁面</h2><p>切換到前端開發模式，我們要修改一下介面的呈現。</p>
<p>先處理 HTML 的部份，將原來的 <code>resources/views/welcome.blade.php</code> 重新命名為 <code>resources/views/chat.blade.php</code> ，將 <code>div.container</code> 的內容修改如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 col-md-offset-3"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Chat Room Demo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 訊息列表框 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"chat-room"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 輸入訊息的表單 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"send-message"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/send-message"</span>&gt;</span></span><br><span class="line">                &#123;!! csrf_field() !!&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; $username &#125;&#125;"</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"input-group-addon"</span>&gt;</span>&#123;&#123; $username &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"message"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">"form-control"</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"input-group-btn"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span> <span class="attr">id</span>=<span class="string">"send"</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>這樣會讓畫面上有一個訊息列表框以及一個輸入訊息的表單，如下圖所示。</p>
<p><img src="/resources/chat-room-demo/interface.png" alt="介面"></p>
<p>接下來稍微調整介面的樣式，編輯 <code>resources/assets/sass/app.scss</code> ，將內容修改如下：</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">@<span class="keyword">import</span> <span class="string">"../../../public/bower_components/bootstrap-sass/assets/stylesheets/bootstrap"</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 訊息列表框</span></span><br><span class="line"><span class="selector-id">#chat-room</span> &#123;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ccc</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">20rem</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line">  <span class="attribute">overflow-x</span>: hidden;</span><br><span class="line">  <span class="attribute">overflow-y</span>: auto;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 單則訊息</span></span><br><span class="line">  <span class="selector-class">.message</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1rem</span>;</span><br><span class="line">    <span class="attribute">margin-bottom</span>: <span class="number">1rem</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 輸入訊息的表單</span></span><br><span class="line"><span class="selector-id">#send-message</span> &#123;</span><br><span class="line">  <span class="attribute">margin-top</span>: -<span class="number">1px</span>;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.input-group-addon</span> &#123;</span><br><span class="line">    <span class="attribute">border-top-left-radius</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.input-group-btn</span> &gt; <span class="selector-class">.btn</span> &#123;</span><br><span class="line">    <span class="attribute">border-top-right-radius</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最後透過 JavaScript 讓所有東西串在一起，</p>
<p>編輯 <code>resources/assets/js/app.js</code> ，內容如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> $chatRoom = $(<span class="string">'#chat-room'</span>);</span><br><span class="line"><span class="keyword">var</span> $sendMessage = $(<span class="string">'#send-message'</span>);</span><br><span class="line"><span class="keyword">var</span> $messageInput = $sendMessage.find(<span class="string">'input[name=message]'</span>);</span><br><span class="line"><span class="keyword">var</span> io = <span class="built_in">window</span>.io;</span><br><span class="line"><span class="keyword">var</span> socket = io(<span class="string">'http://chat-room.app:3000'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 當送出表單時，改用 Ajax 傳送，並清空輸入框。</span></span><br><span class="line">$sendMessage.on(<span class="string">'submit'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.post(<span class="keyword">this</span>.action, $sendMessage.serialize());</span><br><span class="line">    $messageInput.val(<span class="string">''</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 當接收到訊息建立的事件時，將接收到的 payload</span></span><br><span class="line">socket.on(<span class="string">'chat-channel:App\\Events\\MessageCreated'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">payload</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> html = <span class="string">'&lt;div class="message alert-info" style="display: none;"&gt;'</span>;</span><br><span class="line">    html += payload.username + <span class="string">': '</span>;</span><br><span class="line">    html += payload.message;</span><br><span class="line">    html += <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> $message = $(html);</span><br><span class="line">    $chatRoom.append($message);</span><br><span class="line">    $message.fadeIn(<span class="string">'fast'</span>);</span><br><span class="line">    $chatRoom.animate(&#123;<span class="attr">scrollTop</span>: $chatRoom[<span class="number">0</span>].scrollHeight&#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="執行測試"><a href="#執行測試" class="headerlink" title="執行測試"></a>執行測試</h2><p>在 Homestead 上執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gulp</span><br></pre></td></tr></table></figure>
<p>然後在本機分別開啟兩個瀏覽器視窗瀏覽 <code>http://chat-room.app</code> ，然後在輸出框上輸入文字後按 <code>Send</code> ，應該就會讓兩個瀏覽器同時出現相同的文字。</p>
<p><img src="/resources/chat-room-demo/in-use.png" alt="展示"></p>
<p>完成的範例可以在我的 <a href="https://github.com/jaceju/example-laravel-chat-room" target="_blank" rel="noopener">GitHub</a> 上找到。</p>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>這個 Demo 如果真的要在實務上使用，還有很多地方要考慮，例如訊息歷史、使用者登入等等。不過這已經足夠讓我們瞭解 Laravel 5.1 在實作 Broadcasting 時有多麼輕鬆，使得我們更容易在專案前期就先實現很多想法。</p>
<p>希望這個簡單的教學，能對大家使用 Laravel 來開發即時系統時有所幫助。</p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a href="https://laracasts.com/discuss/channels/general-discussion/step-by-step-guide-to-installing-socketio-and-broadcasting-events-with-laravel-51" target="_blank" rel="noopener">Step by Step Guide to Installing Socket.io and Broadcasting Events with Laravel 5.1 </a></li>
</ul>
</div><div class="tags"><a href="/tags/Laravel/">Laravel</a><a href="/tags/PHP/">PHP</a></div><div class="post-nav"><a class="pre" href="/laravel-mailcatcher/">在 Laravel 上用 MailCatcher 發送測試信件</a><a class="next" href="/laravel-5-1/">Laravel 5.1 正式釋出</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://jaceju.net"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分類</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 標籤</i></div><div class="tagcloud"><a href="/tags/Web-開發/" style="font-size: 15px;">Web 開發</a> <a href="/tags/測試/" style="font-size: 15px;">測試</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/TDD/" style="font-size: 15px;">TDD</a> <a href="/tags/心得感想/" style="font-size: 15px;">心得感想</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/ASP/" style="font-size: 15px;">ASP</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Selenium/" style="font-size: 15px;">Selenium</a> <a href="/tags/好書推薦/" style="font-size: 15px;">好書推薦</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/設計模式/" style="font-size: 15px;">設計模式</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/程式開發/" style="font-size: 15px;">程式開發</a> <a href="/tags/伺服器安裝與設定/" style="font-size: 15px;">伺服器安裝與設定</a> <a href="/tags/Refactoring/" style="font-size: 15px;">Refactoring</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/Zend-Framework/" style="font-size: 15px;">Zend Framework</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/what-is-essential-to-frontend-engineers/">身為前端工程師，對你來說，你認為最重要的是什麼？</a></li><li class="post-list-item"><a class="post-list-link" href="/my-2018/">我的 2018 年</a></li><li class="post-list-item"><a class="post-list-link" href="/behat-in-laravel-advance/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 進階篇</a></li><li class="post-list-item"><a class="post-list-link" href="/behat-in-laravel/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇</a></li><li class="post-list-item"><a class="post-list-link" href="/composer-replace/">理解 composer.json 的 replace</a></li><li class="post-list-item"><a class="post-list-link" href="/refactor-or-rebuild/">面對 Legacy Code ，該重構還是重寫？</a></li><li class="post-list-item"><a class="post-list-link" href="/steps-of-refactoring-or-rebuilding/">重構或重寫 Legacy code 的幾個階段</a></li><li class="post-list-item"><a class="post-list-link" href="/to-test-the-detail-or-to-test-the-result/">測試該驗證結果還是該驗證細節</a></li><li class="post-list-item"><a class="post-list-link" href="/php-quality-analysis/">分析 PHP 程式碼品質</a></li><li class="post-list-item"><a class="post-list-link" href="/spotify-engineering-culture/">很值得一看的 Spotify 的工程文化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友站連結</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">網站製作學習誌.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>