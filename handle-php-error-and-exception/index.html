<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>如何在 PHP 中平順地處理 Error 及 Exception ？ | 網站製作學習誌</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="如何在 PHP 中平順地處理 Error 及 Exception ？"><meta name="twitter:description" content="記錄在開發網站時所學的一切"><meta name="og:title" content="如何在 PHP 中平順地處理 Error 及 Exception ？"><meta name="og:site_name" content="網站製作學習誌"><meta name="og:description" content="記錄在開發網站時所學的一切"><meta name="og:type" content="article"><meta name="og:image" content=""></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">如何在 PHP 中平順地處理 Error 及 Exception ？</h1><a id="logo" href="/.">網站製作學習誌</a><p class="description">記錄在開發網站時所學的一切</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首頁</i></a><a href="/archives/"><i class="fa fa-archive"> 所有文章</i></a><a href="/about/"><i class="fa fa-user"> 關於</i></a><a href="/atom.xml"><i class="fa fa-rss"> 訂閱</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">如何在 PHP 中平順地處理 Error 及 Exception ？</h1><div class="post-meta">Apr 23, 2010</div><div class="post-content"><p>在開發 PHP 的時候，最麻煩的事情之一就是處理錯誤。一個好的程式除了要將錯誤訊息呈現給使用者知道之外，也要讓該結束的部份正常結束才行。</p>
<p>而在 PHP5 之後，除了以往的 Error Handling 之外，還多了 Exception Handling ，使得程式變得更難去處理錯誤；所以大多數的開發者只能雙手一攤，讓這些錯誤訊息大剌剌地出現在使用者面前。</p>
<p>有沒有什麼好方法可以讓我們好好控制 Error 和 Exception 呢？</p>
<a id="more"></a>
<h2 id="傳統的做法"><a href="#傳統的做法" class="headerlink" title="傳統的做法"></a>傳統的做法</h2><p>在很多書籍和網路範例裡，當程式出錯時就是讓程序直接死掉，最常見的就是資料庫連線：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$link = mysql_connect(<span class="string">'localhost'</span>, <span class="string">'mysql_user'</span>, <span class="string">'mysql_password'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$link) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Could not connect: '</span> . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Connected successfully'</span>;</span><br><span class="line">mysql_close($link);</span><br></pre></td></tr></table></figure>
<p>或是在送出導向 header 後，就直接 exit ：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">header(<span class="string">"Location: http://www.example.com/"</span>); <span class="comment">/* Redirect browser */</span></span><br><span class="line"><span class="comment">/* Make sure that code below does not get executed when we redirect. */</span></span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>
<p>這些都不是好做法，因為有些流量較大的網站裡可能有多個資料庫連線，或是檔案的 handler 仍在開啟中；如果直接讓程序死亡或離開的話，就沒辦法將這些已經開啟的資源給正常關閉掉，進而造成系統的不穩定。</p>
<h2 id="Exception-的處理"><a href="#Exception-的處理" class="headerlink" title="Exception 的處理"></a>Exception 的處理</h2><p>PHP5 中，有個 <a href="http://www.php.net/manual/en/function.set-exception-handler.php" target="_blank" rel="noopener"><code>set_exception_handler</code></a> 這個函式，它可以幫我們處理 Exception ：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exception_handler</span><span class="params">($exception)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Uncaught exception: "</span> , $exception-&gt;getMessage(), <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set_exception_handler(<span class="string">'exception_handler'</span>);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Uncaught Exception'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Not Executed\n"</span>;</span><br></pre></td></tr></table></figure>
<p>不過我個人認為用 <a href="http://www.php.net/manual/en/language.exceptions.php" target="_blank" rel="noopener"><code>try...catch</code></a> 會讓我們在程式流程上的彈性更大：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inverse</span><span class="params">($x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!$x) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Division by zero.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">1</span>/$x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> inverse(<span class="number">5</span>) . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="keyword">echo</span> inverse(<span class="number">0</span>) . <span class="string">"\n"</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Caught exception: '</span>,  $e-&gt;getMessage(), <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Continue execution</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Hello World'</span>;</span><br></pre></td></tr></table></figure>
<p>而在我研究過 Zend Framework 的做法後，發現它在處理 Exception 上更加聰明。 Zend Framework 在 Controller 中引入一個 Response 物件，所有對瀏覽器的輸出都要經過它 (例如 Header 、 Content Body 等等) ；而這個 Reponse 物件也同時控管著 Exception 是否要被輸出到瀏覽器端，讓程式開發者能有更大的空間處理 Exception 。</p>
<p>以下我簡單把 Zend Framework 在 Response 物件中處理 Exception 的概念整理成一個自製的 <code>Response</code> 類別：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_exceptions = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $_renderExceptions = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setException</span><span class="params">(Exception $e)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_exceptions[] = $e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getExceptions</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_exceptions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isException</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;_exceptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">renderExceptions</span><span class="params">($flag = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> !== $flag) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_renderExceptions = $flag ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_renderExceptions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendResponse</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Header sending...\n"</span>;</span><br><span class="line">        $exception = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isException() &amp;amp;&amp;amp; <span class="keyword">$this</span>-&gt;renderExceptions()) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;getExceptions() <span class="keyword">as</span> $e) &#123;</span><br><span class="line">                $exception .= $e-&gt;getMessage() . <span class="string">"\n"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> $exception;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Body sending...\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要的概念很簡單，就是 Response 物件先把 Exception 先收集起來，然後再視狀況如何處理，例如：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$response = <span class="keyword">new</span> Response();</span><br><span class="line">$response-&gt;renderExceptions(<span class="keyword">true</span>); <span class="comment">// 讓 Exception 呈現出來</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 這裡處理我們真正要執行的動作</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'TEST'</span>); <span class="comment">// 丟出一個測試用的例外</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    $response-&gt;setException($e); <span class="comment">// 收集例外</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($response-&gt;isException()) &#123;</span><br><span class="line">    <span class="comment">// 可以在這裡記錄 Exception</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$response-&gt;sendResponse(); <span class="comment">// 顯示所有結果 (包含 Header, Exception, Body 等)</span></span><br></pre></td></tr></table></figure>
<p>透過了 Response 物件來管理 Exception ，就可以不必因為 Exception 而中斷我們的程式碼。</p>
<h2 id="PHP-Error-的處理"><a href="#PHP-Error-的處理" class="headerlink" title="PHP Error 的處理"></a>PHP Error 的處理</h2><p>雖然 Exception 可以用 <code>try...catch</code> 控制程式流程，但 PHP Error 卻不行。</p>
<p>因為一般處理 PHP Error 的方法是透過 <a href="http://www.php.net/manual/en/function.set-error-handler.php" target="_blank" rel="noopener">set_error_handler</a>，而當執行完自訂的 Error Handler 後，我們卻只能選擇繼續執行下一行程式碼或將程式中斷離開，不然就是要利用全域變數來設定錯誤旗標以達到控制的目的。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$error = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exceptionErrorHandler</span><span class="params">($errno, $errstr, $errfile, $errline)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $error;</span><br><span class="line">    $error = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">echo</span> $errstr, <span class="string">"\n"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set_error_handler(<span class="string">"exceptionErrorHandler"</span>);</span><br><span class="line">strpos();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$error) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Do normal process here.\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"end.\n"</span>;</span><br></pre></td></tr></table></figure>
<p>不過 PHP5 也幫我們想好了，我們可以在 Error Handler 裡丟出 <a href="http://www.php.net/manual/en/class.errorexception.php" target="_blank" rel="noopener">ErrorException</a> ，就可以配合前面提到的 Response 物件做到更平順的 Exception 處理：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">exceptionErrorHandler</span><span class="params">($errno, $errstr, $errfile, $errline )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorException($errstr, <span class="number">0</span>, $errno, $errfile, $errline);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set_error_handler(<span class="string">"exceptionErrorHandler"</span>);</span><br><span class="line">$response = <span class="keyword">new</span> Response();</span><br><span class="line">$response-&gt;renderExceptions(<span class="keyword">true</span>); <span class="comment">// 讓 Exception 呈現出來</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 這裡處理我們真正要執行的動作</span></span><br><span class="line">    trigger_error(<span class="string">'TEST'</span>, E_USER_ERROR); <span class="comment">// 改用 trigger_error 來丟出測試用錯誤</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    $response-&gt;setException($e); <span class="comment">// 收集例外</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($response-&gt;isException()) &#123;</span><br><span class="line">    <span class="comment">// 可以在這裡記錄 Exception</span></span><br><span class="line">&#125;</span><br><span class="line">$response-&gt;sendResponse(); <span class="comment">// 顯示所有結果 (包含 Header, Exception, Body 等)</span></span><br></pre></td></tr></table></figure>
<p>這邊最棒的是 Error Handler 丟出 <code>ErrorException</code> 後， <code>try...catch</code> 就會發生作用，而不再像 <code>set_error_handler</code> 這樣又返回中斷的地方繼續執行，一切就像行雲流水般那麼自然。</p>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><p>一個運作良好的系統必須要對錯誤的發生有最大的掌控權，而不是放任它讓系統墜毀在五里霧之中。</p>
<p>雖然前面提到的處理方式也許不是最佳的，但希望透過這樣的介紹，讓大家能夠思考自己的程式應該如何去處理錯誤這件事。</p>
<p>就寫到這裡吧，收工~</p>
</div><div class="tags"><a href="/tags/PHP/">PHP</a><a href="/tags/Web-開發/">Web 開發</a></div><div class="post-nav"><a class="pre" href="/about-testing/">關於測試這件事</a><a class="next" href="/why-engineer-or-designer-are-always-work-overtime-in-taiwan/">為什麼台灣的工程師 / 設計師常常加班？</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://jaceju.net"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分類</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 標籤</i></div><div class="tagcloud"><a href="/tags/設計模式/" style="font-size: 15px;">設計模式</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/ASP/" style="font-size: 15px;">ASP</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Web-開發/" style="font-size: 15px;">Web 開發</a> <a href="/tags/好書推薦/" style="font-size: 15px;">好書推薦</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/心得感想/" style="font-size: 15px;">心得感想</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/程式開發/" style="font-size: 15px;">程式開發</a> <a href="/tags/伺服器安裝與設定/" style="font-size: 15px;">伺服器安裝與設定</a> <a href="/tags/TDD/" style="font-size: 15px;">TDD</a> <a href="/tags/測試/" style="font-size: 15px;">測試</a> <a href="/tags/Selenium/" style="font-size: 15px;">Selenium</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/Refactoring/" style="font-size: 15px;">Refactoring</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/how-i-built-my-side-project/">我如何從需求出發到完成一個專案</a></li><li class="post-list-item"><a class="post-list-link" href="/function-name-must-be-a-string-in-laravel-testing/">Laravel 執行測試時出現 Function name must be a string</a></li><li class="post-list-item"><a class="post-list-link" href="/what-is-essential-to-frontend-engineers/">身為前端工程師，對你來說，你認為最重要的是什麼？</a></li><li class="post-list-item"><a class="post-list-link" href="/my-2018/">我的 2018 年</a></li><li class="post-list-item"><a class="post-list-link" href="/behat-in-laravel-advance/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 進階篇</a></li><li class="post-list-item"><a class="post-list-link" href="/behat-in-laravel/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇</a></li><li class="post-list-item"><a class="post-list-link" href="/composer-replace/">理解 composer.json 的 replace</a></li><li class="post-list-item"><a class="post-list-link" href="/steps-of-refactoring-or-rebuilding/">重構或重寫 Legacy code 的幾個階段</a></li><li class="post-list-item"><a class="post-list-link" href="/refactor-or-rebuild/">面對 Legacy Code ，該重構還是重寫？</a></li><li class="post-list-item"><a class="post-list-link" href="/to-test-the-detail-or-to-test-the-result/">測試該驗證結果還是該驗證細節</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友站連結</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">網站製作學習誌.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>