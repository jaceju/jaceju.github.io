<!DOCTYPE html>
<html lang="zh-TW">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#709478">
	<meta name="msapplication-TileColor" content="#709478">
<meta itemprop="name" content="關於 PHP Traversing 的這檔事">
<meta itemprop="description" content="foreach 大概是 PHP 程式中最常見的語法結構之後，本文將會介紹 foreach 的一些觀念，以及幾個跟它相關的 PHP 7 特色。 foreach 起手式 常見的 foreach 用法 一般我們最常看到 foreach 用在遍歷 (traversing)">
<meta itemprop="datePublished" content="2019-12-24T10:37:59+08:00" />
<meta itemprop="dateModified" content="2019-12-24T10:37:59+08:00" />
<meta itemprop="wordCount" content="3206">



<meta itemprop="keywords" content="CSS," />
<meta property="og:title" content="關於 PHP Traversing 的這檔事" />
<meta property="og:description" content="foreach 大概是 PHP 程式中最常見的語法結構之後，本文將會介紹 foreach 的一些觀念，以及幾個跟它相關的 PHP 7 特色。 foreach 起手式 常見的 foreach 用法 一般我們最常看到 foreach 用在遍歷 (traversing)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jaceju.net/all-about-php-traversing/" />
<meta property="article:published_time" content="2019-12-24T10:37:59+08:00" />
<meta property="article:modified_time" content="2019-12-24T10:37:59+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="關於 PHP Traversing 的這檔事"/>
<meta name="twitter:description" content="foreach 大概是 PHP 程式中最常見的語法結構之後，本文將會介紹 foreach 的一些觀念，以及幾個跟它相關的 PHP 7 特色。 foreach 起手式 常見的 foreach 用法 一般我們最常看到 foreach 用在遍歷 (traversing)"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>關於 PHP Traversing 的這檔事</title>
	<link rel="stylesheet" href="https://jaceju.net/css/style.min.657bcb7af31123e4156b1a3d2ff60a636717e54ead74f882136b5114cf72b55e.css" integrity="sha256-ZXvLevMRI+QVaxo9L/YKY2cX5U6tdPiCE2tRFM9ytV4=" crossorigin="anonymous">
	
	<link rel="stylesheet" href="https://jaceju.net/css/my.css">
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://jaceju.net">網站製作學習誌</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://jaceju.net/posts/">Posts</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/jaceju" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/jaceju" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://jaceju.net/posts/">Posts</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Dec 24, 2019</span></div>
				<h1>關於 PHP Traversing 的這檔事</h1>
			</header>
			<div class="content">
				<p><code>foreach</code> 大概是 PHP 程式中最常見的語法結構之後，本文將會介紹 <code>foreach</code> 的一些觀念，以及幾個跟它相關的 PHP 7 特色。</p>
<!-- raw HTML omitted -->
<h2 id="foreach-起手式">foreach 起手式<a href="#foreach-起手式" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="常見的-foreach-用法">常見的 foreach 用法<a href="#常見的-foreach-用法" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>一般我們最常看到 <a href="https://www.php.net/manual/en/control-structures.foreach.php"><code>foreach</code></a> 用在遍歷 (traversing) 陣列裡的元素，例如：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">$arr = [1, 2, 3];

foreach ($arr as $num) {
    echo &#34;$num\n&#34;;
}
</code></pre></div><p>而如果想遍歷關連式陣列 (associative array) ，同時取得元素的鍵 (key) 與值 (value) ，可以用以下語法：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">$arr = [&#39;a&#39; =&gt; 1, &#39;b&#39; =&gt; 2, &#39;c&#39; =&gt; 3];

foreach ($arr as $key =&gt; $num) {
    echo &#34;$key =&gt; $num\n&#34;;
}
</code></pre></div><p>如果陣列元素本身也是陣列，我們稱為「巢狀陣列 (nested array) 」。在遍歷巢狀陣列時，我們可以用 <code>list(...)</code> 來解構每個陣列元素：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">$arr = [
    [&#39;a&#39;, 1],
    [&#39;b&#39;, 2],
    [&#39;c&#39;, 3],
];

foreach ($arr as list($alpha, $num)) {
    echo &#34;$alpha =&gt; $num\n&#34;;
}
</code></pre></div><p>在 PHP 7.1 之後，你可以用方括號來取代 <code>list()</code> ：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">foreach ($arr as [$alpha, $num]) {
    echo &#34;$alpha =&gt; $num\n&#34;;
}
</code></pre></div><p>當然別忘了 PHP 7.1 之後， <code>list()</code> 可以用指定鍵的方式來取值：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">$users = [
    [&#39;id&#39; =&gt; 1, &#39;name&#39; =&gt; &#39;Alice&#39;, &#39;age&#39; =&gt; 18],
    [&#39;id&#39; =&gt; 2, &#39;name&#39; =&gt; &#39;Bob&#39;, &#39;age&#39; =&gt; 24],
    [&#39;id&#39; =&gt; 3, &#39;name&#39; =&gt; &#39;Carl&#39;, &#39;age&#39; =&gt; 33]
];

foreach ($users as [&#39;name&#39; =&gt; $name, &#39;age&#39; =&gt; $age, &#39;id&#39; =&gt; $id]) {
    var_dump(&#34;$id $name: $age&#34;);
}
</code></pre></div><h3 id="如果沒有-foreach">如果沒有 foreach<a href="#如果沒有-foreach" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>PHP 有提供幾個函式用來操作陣列裡的指標，以及取得指標指向的陣列元素；分別是 <a href="https://www.php.net/manual/en/function.reset.php"><code>reset</code></a> / <a href="https://www.php.net/manual/en/function.prev.php"><code>prev</code></a> / <a href="https://www.php.net/manual/en/function.next.php"><code>next</code></a> / <a href="https://www.php.net/manual/en/function.current.php"><code>current</code></a> / <a href="https://www.php.net/manual/en/function.end.php"><code>end</code></a> 。</p>
<p>你可以用 <a href="https://www.php.net/manual/en/control-structures.while.php"><code>while</code></a> 搭配以上的函式來遍歷陣列：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">$arr = [null, 1, 2, false, null, 3, 4];

// 直接找到最後一個元素
// 這裡指標是指向最後一個元素
var_dump(end($arr));

// 因為指標已經跑到最後一個元素的位置
// 所以要重置指標
reset($arr);

// 遍歷陣列裡的元素
while (!is_null(key($arr))) {
    var_dump(current($arr));
    next($arr);
}

// 指標的位置已經沒有元素了
var_dump(current($arr));
</code></pre></div><p>另一個不用 <code>foreach</code> 的方法是使用 <code>array_walk</code> 這個函式：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">$arr = [1, 2, 3];

array_walk($arr, function ($item) {
    echo &#34;$item &#34;;
});

$arr = [&#39;a&#39; =&gt; 1, &#39;b&#39; =&gt; 2, &#39;c&#39; =&gt; 3];

array_walk($arr, function ($item, $key) {
    echo &#34;$key =&gt; $item&#34;;
});
</code></pre></div><h3 id="用-foreach-來列舉物件屬性">用 foreach 來列舉物件屬性<a href="#用-foreach-來列舉物件屬性" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><code>foreach</code> 也可以用來列舉 (listing) 物件的屬性，只要該物件不是屬於可遍歷的物件。</p>
<p>當你對一個物件實體用 <code>foreach</code> 來列舉屬性的話，你只能看到它的公開屬性：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">class MyClass
{
    public $publicVar = &#39;public var&#39;;

    protected $protectedVar = &#39;protected var&#39;;

    private $privateVar = &#39;private var&#39;;
}

$class = new MyClass();

foreach ($class as $key =&gt; $value) {
    echo &#34;$key =&gt; $value\n&#34;;
}
</code></pre></div><p>但是如果你是在物件內部對 <code>$this</code> 做列舉屬性，那麼你可以看到這個物件所有的屬性：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">class MyClass
{
    public $publicVar = &#39;public var&#39;;

    protected $protectedVar = &#39;protected var&#39;;

    private $privateVar = &#39;private var&#39;;

    public function iterateSelf()
    {
        foreach ($this as $key =&gt; $value) {
            print &#34;$key =&gt; $value\n&#34;;
        }
    }
}

$class = new MyClass();

$class-&gt;iterateSelf();
</code></pre></div><p>注意，之所以特意用「列舉屬性」將「遍歷元素」的概念區分開來，實在是因為 <code>foreach</code> 對 PHP 物件的操作真的很微妙。</p>
<p>一般來說，我們希望用 <code>foreach</code> 來遍歷集合的元素，而不是列舉物件的屬性；所以當物件屬於一個集合時，就需要讓物件所屬的類別實作一些特別的介面。</p>
<h2 id="用-foreach-來遍歷的介面">用 foreach 來遍歷的介面<a href="#用-foreach-來遍歷的介面" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<h3 id="traversable">Traversable<a href="#traversable" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>如果你需要的是一個可以被遍歷的物件 (通常是集合物件) ，那麼你可以檢查它是不是屬於 <code>Traversable</code> 這個介面。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">if ($obj instanceof Traversable) {
    // ...
}
</code></pre></div><p>但是要注意 <code>Traversable</code> 的幾個特點：</p>
<ol>
<li>類別不能直接實作 <code>Traversable</code> 介面。</li>
<li>雖然陣列可以用 <code>foreach</code> 來遍歷，但它並不屬於 <code>Traversable</code> 介面。</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">// 不能直接實作
class MyExample implements Traversable {} // Error

// 陣列不屬於 Traversable
$arr = [1, 2, 3];
var_dump($arr instanceof Traversable); // false
</code></pre></div><p>再次強調：物件雖然可以用 <code>foreach</code> 來操作，但它不一定是 <code>Traversable</code> 。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">// 物件可以 foreach 列舉屬性，但不一定是 Traversable
$obj = (object) [&#39;a&#39; =&gt; 1, &#39;b&#39; =&gt; 2, &#39;c&#39; =&gt; 3];
foreach ($obj as $key =&gt; $value) {
    echo &#34;$key =&gt; $value\n&#34;;
}
var_dump($obj instanceof Traversable); // false

class MyExample {}
$obj = new MyExample();
var_dump($obj instanceof Traversable); // false
</code></pre></div><h3 id="iterator-與-iteratoraggregate">Iterator 與 IteratorAggregate<a href="#iterator-與-iteratoraggregate" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>由於不能直接實作 <code>Traversable</code> 介面，官方建議應該改為實作 <code>Iterator</code> 或是 <code>IteratorAggregate</code> 這類的介面，它們都繼承自 <code>Traversable</code> 介面。</p>
<p><code>Iterator</code> 介面就如同前面介紹的 <code>next</code> 、 <code>current</code> 等函式一樣，提供了操作指標與取得指標所指向的元素等方法介面，以供類別來實作。</p>
<p>以下是一個很典型的範例：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">class IteratorExample implements Iterator
{
    private $position = 0;

    private $data = [];

    public function __construct(array $data)
    {
        $this-&gt;position = 0;
        $this-&gt;data = $data;
    }

    public function rewind()
    {
        $this-&gt;position = 0;
    }

    public function current()
    {
        return $this-&gt;data[$this-&gt;position];
    }

    public function key()
    {
        return $this-&gt;position;
    }

    public function next()
    {
        ++$this-&gt;position;
    }

    public function valid()
    {
        return array_key_exists(
            $this-&gt;position,
            $this-&gt;data
        );
    }
}
</code></pre></div><p>我們可以用 <code>while</code> 敘述來遍歷 <code>Iterator</code> 物件裡的元素：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">$it = new IteratorExample([&#39;a&#39;, null, &#39;b&#39;, &#39;c&#39;]);

$it-&gt;rewind();

while ($it-&gt;valid()) {
    $key = $it-&gt;key();
    var_dump($it-&gt;current());
    $it-&gt;next();
}
</code></pre></div><p>當然也可以用 <code>foreach</code> 來遍歷，因為這時所生成的物件實體已經屬於 <code>Traversable</code> 介面了：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">foreach ($it as $value) {
    var_dump($value);
}

var_dump($it instanceof Traversable); // true
</code></pre></div><p>實作 <code>Iterator</code> 介面的好處，就是可以依照自定義的邏輯來遍歷物件內的元素，這在某些特別的情境下很好用。</p>
<p>另一個更為簡便的介面是 <code>IteratorAggregate</code> ，它只需要實作 <code>getIterator</code> 這個方法就可以了， <code>getIterator</code> 方法必須回傳一個實作 <code>Iterator</code> 的物件。</p>
<p>PHP 內建了<a href="https://www.php.net/manual/en/spl.iterators.php">多種 Iterator 類別</a>讓開發者不需要從頭定義一個實作 <code>Iterator</code> 介面的類別，以下示範 <code>ArrayIterator</code> 這個類別如何跟 <code>IteratorAggregate</code> 介面搭配：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">class IteratorAggregateExample implements IteratorAggregate
{
    private $data = [];

    public function __construct(array $data)
    {
        $this-&gt;data = $data;
    }

    public function getIterator()
    {
        return new ArrayIterator($this-&gt;data);
    }
}

$it = new IteratorAggregateExample([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]);

foreach ($it as $value) {
    echo &#34;$value\n&#34;;
}
</code></pre></div><p>用 <code>IteratorAggregate</code> 介面的好處是，你可以動態更換 <code>getIterator</code> 方法的回傳內容，而不必讓程式綁死在特定的 Iterator 類別上。</p>
<h3 id="iterable-型別">iterable 型別<a href="#iterable-型別" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><code>Traversable</code> 雖然可以用來判斷變數可否被遍歷，但它卻不適用在陣列變數上。因此 PHP 在 7.1 加入了一個偽型別 (pseudo-type) ： <a href="https://www.php.net/manual/en/language.types.iterable.php"><code>iterable</code></a> ，可以用在 <a href="https://www.php.net/manual/en/functions.arguments.php#functions.arguments.type-declaration">Argument type declarations</a> (即 type hint) 及 <a href="https://www.php.net/manual/en/functions.returning-values.php#functions.returning-values.type-declaration">Return type declarations</a> 上。</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function getArr(): iterable
{
    return [&#39;a&#39; =&gt; 1, &#39;b&#39; =&gt; 2, &#39;c&#39; =&gt; 3];
}

function traverse(iterable $list)
{
    foreach ($list as $item) {
        echo &#34;$item &#34;;
    }
}

$arr = getArr();
$it = new ArrayIterator($arr);

var_dump(is_iterable($arr)); // true
var_dump(is_iterable($it));  // true

traverse($arr); // 1 2 3
traverse($it);  // 1 2 3
</code></pre></div><p>因此建議在程式中，可以用 <code>iterable</code> 型別來取代 <code>Traversable</code> 介面。</p>
<h2 id="如何在-foreach-時節省記憶體">如何在 foreach 時節省記憶體<a href="#如何在-foreach-時節省記憶體" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>有時候要遍歷的對象，在生成後可能會佔用很大的記憶體空間，這可能會造成 PHP 執行時期的記憶體不足。以 <code>range</code> 為例：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function showMemUsageIf(bool $show = false): void
{
    if ($show) {
        echo round(memory_get_usage() / 1024 / 1024, 2) . &#39; MB&#39; . PHP_EOL;
    }
}

showMemUsageIf(true); // 15.42 MB
$a = range(1, 1000000);
foreach ($a as $num) { ... }
showMemUsageIf(true); // 47.43 MB
</code></pre></div><p>因此在 PHP 5.5 之後的版本，提供了 <a href="https://www.php.net/manual/en/class.generator.php">Generator</a> 這個類別，它可以協助我們在必要時才生成要處理的元素。</p>
<p>但是你不能直接用 <code>new</code> 來生成一個 <code>Generator</code> 類別的物件實體，取而代之的是 PHP 提供了 <code>yield</code> 這個新語法。</p>
<p><code>yield</code> 用途和 <code>return</code> 很類似，但 <code>yield</code> 只能放在函式或類別方法中，而包含了 <code>yield</code> 的函式或類別方法，其回傳值的型態都是 <code>Generator</code> 類別。</p>
<p>由於 <code>Generator</code> 類別實作了 <code>Iterator</code> 介面，所以可以用 <code>foreach</code> 來遍歷其物件實體。</p>
<p>先來看一個基本的 <code>yield</code> 用法：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function gen()
{
    echo &#34;a: &#34;;
    yield 1;

    echo &#34;b: &#34;;
    yield 2;

    echo &#34;c: &#34;;
    yield 3;

    // 當然也可以放在迴圈裡
    foreach ([&#39;d&#39; =&gt; 4, &#39;e&#39; =&gt; 5] as $key =&gt; $num) {
        echo &#34;$key: &#34;;
        yield $num;
    }
}

foreach (gen() as $num) {
    echo &#34;$num &#34;;
}
</code></pre></div><p>可以看到當執行 <code>foreach</code> 的第一輪時， <code>gen()</code> 函式並不是一次跑完，而是會停在第一個 <code>yield</code> 上，並回傳 <code>yield</code> 後面的值。而第二輪則是從第一個 <code>yield</code> 後繼續執行，然後停在第二個 <code>yield</code> 。</p>
<p>由此可以看出，每當執行到 <code>yield</code> 時， <code>Generator</code> 就會保留目前的執行位置，並給出當下 <code>yield</code> 的結果，這在處理大量資料時就顯得非常有用了。</p>
<p>所以我們用 <code>Generator</code> 來重寫 <code>range</code> ，這個新函式我們命名為 <code>xrange</code> ：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function xrange($start, $limit, $step = 1) {
    if ($start <span class="err">&lt;</span> $limit) {
        if ($step <span class="err">&lt;</span>= 0) {
            throw new LogicException(&#39;Step must be +ve&#39;);
        }

        for ($i = $start; $i <span class="err">&lt;</span>= $limit; $i += $step) {
            yield $i;
        }
    } else {
        if ($step &gt;= 0) {
            throw new LogicException(&#39;Step must be -ve&#39;);
        }

        for ($i = $start; $i &gt;= $limit; $i += $step) {
            yield $i;
        }
    }
}

showMemUsageIf(true); // 15.42 MB
$a = xrange(1, 1000000);
foreach ($a as $num) { ... }
showMemUsageIf(true); // 15.42 MB
</code></pre></div><p>可以看到改用 <code>Generator</code> 後，記憶體的用量幾乎沒有什麼改變。</p>
<p>再舉一個例子，例如我們想要處理一個超大的 log 文字檔：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function readLog(string $file)
{
    $f = fopen($file, &#39;r&#39;);
    try {
        while ($line = fgets($f)) {
            yield $line;
        }
    } finally {
        fclose($f);
    }
}

foreach (readLog(&#34;access.log&#34;) as $line) {
    // echo $line;
}
</code></pre></div><p>透過這個方式，我們可以把每一行 log 的處理邏輯和讀檔邏輯分離開來，而且也不會佔用太多記憶體。</p>
<h3 id="generator-的特異功能">Generator 的特異功能<a href="#generator-的特異功能" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p><code>Generator</code> 有幾個特別 <code>yield</code> 的用法，這裡特別介紹一下。</p>
<p><code>yield</code> 可以跟 <code>return</code> 一起使用，不過這時候必須用 <code>Generator::getReturn()</code> 來取得回傳值：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function getValues(): iterable
{
    yield &#39;value&#39;;
    return &#39;returnValue&#39;;
}

$values = getValues(); // $values 是一個 Generator
foreach ($values as $value) {
    var_dump($value);
}
echo $values-&gt;getReturn(); // &#39;returnValue&#39;
</code></pre></div><p><code>yield</code> 可以回傳鍵 (key) 與值 (value) ：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function getMembers(): iterable
{
    yield &#39;a&#39; =&gt; 1;
    yield &#39;b&#39; =&gt; 2;
    yield &#39;c&#39; =&gt; 3;
}

foreach (getMembers() as $key =&gt; $value) {
    echo &#34;$key: $value\n&#34;;
}
</code></pre></div><p>巢狀的 Generator 可以用 <code>yield from</code> 來達成， <code>yield from</code> 後面要跟著一個 <code>iterable</code> 的值：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function one(): iterable
{
    yield 1;
}

function two_one(): iterable
{
    yield 2;
    yield from one();
}

function ten_to_seven(): iterable
{
    for ($i = 10; $i &gt;= 7; $i--) {
        yield $i;
    }
}

function count_down(): iterable
{
    yield from ten_to_seven();
    yield from [6, 5];
    yield from new ArrayIterator([4, 3]);
    yield from two_one();
}

foreach (count_down() as $num) {
    echo &#34;$num &#34;;
}
</code></pre></div><p>當然 <code>yield</code> 也可以用來回傳匿名函式：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function getFunctions()
{
    yield function ($num) {
        return $num;
    };

    yield function ($num) {
        return $num + 1;
    };

    yield function ($num) {
        return $num + 2;
    };
}

foreach (getFunctions() as $func) {
    var_dump($func(1));
}
</code></pre></div><p>但以下這個例子是錯誤的，因為 anonymous function 是一個 <code>Closure</code> 物件，不能接在 <code>yield from</code> 後面：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function getFunctions()
{
    yield from function ($num) {
        for ($i = 1; $i <span class="err">&lt;</span>= $num; $i++) {
            yield $i;
        }
    };
}

foreach (getFunctions() as $func) {
    // ...
}

// PHP Fatal error:  Uncaught Error: Can use &#34;yield from&#34; only with arrays and Traversables
</code></pre></div><p>直接 <code>yield</code> 就可以了：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">function getFunctions()
{
    yield function ($num) {
        for ($i = 1; $i <span class="err">&lt;</span>= $num; $i++) {
            yield $i;
        }
    };

    yield function ($num) {
        for ($i = $num; $i &gt;= 1; $i--) {
            yield $i;
        }
    };
}

foreach (getFunctions() as $func) {
    foreach ($func(10) as $result) {
        var_dump($result);
    }
}
</code></pre></div><h2 id="在-phpunit-的-data-providers-中使用-yield">在 PHPUnit 的 Data Providers 中使用 yield<a href="#在-phpunit-的-data-providers-中使用-yield" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>在寫 PHPUnit 的測試案例時，我們通常會對某個單元的程式給出多組不同的測試資料，好驗證它的邏輯正確性；而這通常會透過 <a href="https://phpunit.readthedocs.io/en/8.5/writing-tests-for-phpunit.html#data-providers">Data Providers</a> 這個機制來完成，例如以下這個加法測試：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">use PHPUnit\Framework\TestCase;

class DataTest extends TestCase
{
    /**
     * @dataProvider additionProvider
     *
     * @param int $a
     * @param int $b
     * @param int $expected
     */
    public function testAdd(int $a, int $b, int $expected)
    {
        $this-&gt;assertSame($expected, $a + $b);
    }

    public function additionProvider(): iterable
    {
        return [
            [0, 0, 0],
            [0, 1, 1],
            [1, 0, 1],
            [1, 1, 2],
        ];
    }
}
</code></pre></div><p>在上面的測試中， <code>additionProvider</code> 這個方法就是我們的 data-provider ，它必須回傳一個陣列 (這裡稱為 data set) 的陣列；而在測試案例 <code>testAdd</code> 這個方法上，我們要加入它的註解，並用 <code>@dataProvider</code> 來宣告我們的 data-provider 是 <code>additionProvider</code> 這個方法；而 <code>additionProvider</code> 的第二層陣列的項目 (即 data set 裡的每個元素) ，就會依序代入 <code>testAdd</code> 方法參數 <code>$a</code> 、 <code>$b</code> 、 <code>$expected</code> 裡。</p>
<p>不過很多剛用 data-provider 的朋友常會忘了要包第一層的陣列，導致測試錯誤；這裡我們可以改用 <code>yield</code> 來回傳每個 data set ，好避開這類的錯誤，同時也可以讓 data-provider 更加易讀 (雖然要多打幾個 <code>yield</code> 就是了) ：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">    public function additionProvider(): iterable
    {
        yield [0, 0, 0];
        yield [0, 1, 1];
        yield [1, 0, 1];
        yield [1, 1, 2];
    }
</code></pre></div><p>當然也可以用 <code>key =&gt; value</code> 的形式：</p>
<div class="highlight"><pre class="chroma"><code class="language-php" data-lang="php">    public function additionProvider(): iterable
    {
        yield &#39;Set 1&#39; =&gt; [0, 0, 0];
        yield &#39;Set 2&#39; =&gt; [0, 1, 1];
        yield &#39;Set 3&#39; =&gt; [1, 0, 1];
        yield &#39;Set 4&#39; =&gt; [1, 1, 2];
    }
</code></pre></div><h2 id="參考">參考<a href="#參考" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<ul>
<li><a href="https://www.jianshu.com/p/86fefb0aacd9">php 之 Generator 生成器及 yield</a></li>
<li><a href="https://learnku.com/laravel/t/8704/using-yield-to-do-memory-optimization-in-php">在 PHP 中使用 <code>yield</code> 來做內存優化</a></li>
<li><a href="https://www.entropywins.wtf/blog/2017/10/09/yield-in-phpunit-data-providers/">Yield in PHPUnit data providers</a></li>
</ul>

			</div>

<div class="related-posts thin">
	<h2></h2>
	<ul>
	
	<li><a href="/css3-animation-notes/">CSS3 動畫基礎</a></li>
	
	<li><a href="/css-float/">CSS 排版觀念：Float</a></li>
	
	<li><a href="/css-box-model/">CSS 排版觀念：Box Model</a></li>
	
	<li><a href="/css-position/">CSS 排版觀念：Position</a></li>
	
	</ul>
</div>

			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://jaceju.net/tags/css">CSS</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-12-24 10:37 &#43;0800</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://jaceju.net/my-2019/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;</span><br><span>我的 2019 年</span>
			</a>
			<a class="prev-post" href="https://jaceju.net/review-reengineering-legacy-software/">
				<span class="post-nav-label">&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>《遺留系統重建實戰》導讀與心得</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2020 <a href="https://jaceju.net">Jace Ju</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://jaceju.net/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://jaceju.net/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-450710-8', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
