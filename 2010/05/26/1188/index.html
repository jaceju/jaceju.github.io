<!DOCTYPE html><html lang="zh-tw"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>初探 Zend Framework 上的 Context 輸出 | 網站製作學習誌</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">初探 Zend Framework 上的 Context 輸出</h1><a id="logo" href="/.">網站製作學習誌</a><p class="description">記錄在開發網站時所學的一切</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> 首頁</i></a><a href="/archives/"><i class="icon-archive"> 所有文章</i></a><a href="/about/"><i class="icon-about"> 關於</i></a><a href="/atom.xml"><i class="icon-rss"> 訂閱</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">初探 Zend Framework 上的 Context 輸出</h1><div class="post-meta">2010-05-26</div><div class="post-content"><p>在 Zend Framework 1.5 版之後就支援了對 Ajax Context 的處理，讓我們可以在 Controller 裡的 Action 輸出不同的格式的內容，以下我將簡單介紹這個功能。</p>
<a id="more"></a>
<h2 id="Context_的概念與實作">Context 的概念與實作</h2><p>在 Zend Framework 中，不同格式的輸出內容稱為 Context ；每個 Action 都可以輸出不同的 Context ，例如  JSON 、 XML 等等。</p>
<p>如果同一個 Action 要輸出不同格式的內容時，我們可以透過一個叫做 ContextSwitch 的 Action Helper 來幫我們切換 Context 。 ContextSwitch Helper 主要的原理是看有沒有接收到 format 這個參數，如果有的話，就會以該種格式的 Context 輸出。</p>
<p> Zend Framework 預設提供可切換的 Context 格式有 JSON 和 XML 兩種，而 HTML 本身雖然也是一種 Context ，但因為它是在沒有 format 這個參數的狀況下的直接輸出，所以並不需要用 ContextSwitch 特別指定；也就是說，不給 format 的話， Zend Framework 預設會拋出該網址的 HTML ，而不是 JSON 或 XML 。</p>
<h3 id="輸出_JSON">輸出 JSON</h3><p>假設我們有個專案叫 ajaxtest ，它的網址是 <a href="http://localhost/ajaxtest/" target="_blank" rel="external">http://localhost/ajaxtest/</a> 。現在我們想要讓首頁可以輸出 JSON ，我們可以在 Action Controller 的 init 方法中透過 ContextSwitch Helper 設定：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;?php&#10;require_once &#39;Zend/Controller/Action.php&#39;;&#10;class IndexController extends Zend_Controller_Action&#10;&#123;&#10;    public function init()&#10;    &#123;&#10;        $this-&#62;_helper-&#62;contextSwitch()&#10;                      -&#62;addActionContext(&#39;index&#39;, &#39;json&#39;)&#10;                      -&#62;initContext();&#10;    &#125;&#10;    public function indexAction()&#10;    &#123;&#10;        $this-&#62;view-&#62;test = &#39;TEST&#39;;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>透過 ContextSwitch 的 addActionContext ，我們可以幫 indexAction 加入一個 JSON 格式的 Context 輸出；然後再透過 initContext 方法， ContextSwitch Helper 就會判斷目前的網址來做 Context 切換的動作。</p>
<p>現在我們只要在瀏覽器網址列輸入 <a href="http://localhost/ajaxtest/?format=json" target="_blank" rel="external">http://localhost/ajaxtest/?format=json</a> ，就能得到以下的輸出結果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#34;test&#34;:&#34;TEST&#34;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="輸出_XML">輸出 XML</h3><p>不過除了 JSON 格式的 Context 預設不需要樣版之外，其他格式的 Context 都預設都需要準備一個對應的樣版；而這些樣版都會使用 Zend_View 來處理，所以如果你的 View 是用 Smarty ，那麼 ZF 也會用 Smarty   來處理 Context 樣版。</p>
<p>Context 樣版的檔名規則就是 action-name.context-suffix.view-suffix ，這裡的 context-suffix 是 Context 指定的字尾，通常會和 Context 名稱相同；而 view-suffix 就是副檔名，預設是 phtml。</p>
<p>假設現在我們要讓首頁支援 XML 的輸出，那麼首先我們要在 /path/to/ajaxtest/application/views/scripts/index/ 路徑 (就是放 index.phtml 的那個路徑) 下，再按照前述的規則加入一個 index.xml.phtml 檔，內容如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&#62;&#10;&#60;root&#62;&#10;&#60;test&#62;&#60;?php echo $this-&#62;test; ?&#62;&#60;/test&#62;&#10;&#60;/root&#62;</span><br></pre></td></tr></table></figure>
<p>註： XML 的內容規格要看實際需求來訂定，這邊提供的是簡易的範例。</p>
<p>而因為 index.xml.phtml 也是透過 Zend_View 處理，所以這裡我們可以將它當做是 View Script 來處理。</p>
<p>接著我們在 Controller 的 init 方法裡再加入新的 XML Context ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;?php&#10;require_once &#39;Zend/Controller/Action.php&#39;;&#10;class IndexController extends Zend_Controller_Action&#10;&#123;&#10;    public function init()&#10;    &#123;&#10;        $this-&#62;_helper-&#62;contextSwitch()&#10;                      -&#62;addActionContext(&#39;index&#39;, &#39;json&#39;)&#10;                      -&#62;addActionContext(&#39;index&#39;, &#39;xml&#39;)&#10;                      -&#62;initContext();&#10;    &#125;&#10;    public function indexAction()&#10;    &#123;&#10;        $this-&#62;view-&#62;test = &#39;TEST&#39;;&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>完成後在瀏覽器網址列輸入 <a href="http://localhost/ajaxtest/?format=xml" target="_blank" rel="external">http://localhost/ajaxtest/?format=xml</a> ，就能得到以下結果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&#62;&#10;&#60;root&#62;&#10;&#60;test&#62;TEST&#60;/test&#62;&#10;&#60;/root&#62;</span><br></pre></td></tr></table></figure>
<h2 id="自訂_Context">自訂 Context</h2><p>除了 JSON 和 XML 之外，我們也可以自訂 Context ，例如 RSS 、 ATOM 等。例如我們想讓首頁支援 RSS ，那麼也一樣是在 View Scripts 目錄下放置一個 index.rss.phtml (參照上面的規則) ，例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34; ?&#62;&#10;&#60;rss version=&#34;2.0&#34;&#62;&#10;  &#60;channel&#62;&#10;    &#60;item&#62;&#10;    &#60;/item&#62;&#10;  &#60;/channel&#62;&#10;&#60;/rss&#62;</span><br></pre></td></tr></table></figure>
<p>然後我們要透過 contextSwitch 的 addContext 方法，加入自訂的 RSS Context 格式，當然也別忘了將 RSS Context 格式加入 index Action 裡：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$this-&#62;_helper-&#62;contextSwitch()&#10;              -&#62;addContext(&#39;rss&#39;, array(&#39;suffix&#39; =&#62; &#39;rss&#39;))&#10;              -&#62;addActionContext(&#39;index&#39;, &#39;rss&#39;)&#10;              -&#62;initContext();</span><br></pre></td></tr></table></figure>
<p>在 addContext 的第二個參數裡，我們可以指定 Context 的規格，一般來說只要加入 suffix 這個規格即可，它就是前面提到的 context-suffix 。</p>
<h2 id="AjaxContext">AjaxContext</h2><p>在預設打開 Layout 的狀況下， Zend Framework 丟出來的 HTML 是當然是包含 Layout ，而 ContextSwitch 這個 Helper 目前只對有註冊的 Context 關掉 Layout (也就是有指定 format) 。可是當我們指定 format 為 html 時，就會發現程式出現錯誤，因為我們沒有註冊 HTML 這個 Context 。</p>
<p>而改用 AjaxContext 這個 Action Helper 的話，它就會幫我們註冊 HTML 這個 context ；而它是繼承 ContextSwitch 這個 Helper ，所以也保有它完整的功能。</p>
<p>但是使用 AjaxContext 要注意幾個地方：</p>
<ul>
<li><p>AjaxContext 不會使用預設的 action-name.view-suffix 這個樣版，因為它的 context-suffix 是 ajax ，所以我們要多加一個 View Script 叫 action-name.ajax.view-suffix 。</p>
</li>
<li><p>AjaxContext 一定要 Request 是 XMLHttpRequest 才會動作，也就是說必須透過前端 JavaScript 以 XMLHttpRequest 物件來呼叫，這裡和 ContextSwitch 是不一樣的。</p>
</li>
</ul>
<p>AjaxContext 使用方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$this-&#62;_helper-&#62;ajaxContext()&#10;      -&#62;addActionContext(&#39;index&#39;, &#39;html&#39;)&#10;      -&#62;initContext();</span><br></pre></td></tr></table></figure>
<p>如果 index.ajax.phtml 和 index.phtml 的內容是一樣的話，那麼可以將  index.ajax.phtml 改為：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#60;?php echo $this-&#62;partial(&#39;index/index.phtml&#39;); ?&#62;</span><br></pre></td></tr></table></figure>
<p>讓它直接抓取  index.phtml 的內容即可。</p>
<h2 id="心得">心得</h2><p>以前我在處理不同格式輸出時，總是會在 Action 裡加了很多判斷，不僅看起來雜亂，而且也不易維護。</p>
<p>雖然後來我在自定的架構裡做了自動化，但總覺得還是不夠漂亮。而當我認真將 Zend Framework 在處理 Context 這部份的做法仔細研究之後，發現 Zend Framework 確實是讓這件事變得簡單很多。</p>
<p>當然這也只是基礎而已，但是只要將這些基本技巧摸熟之後，相信大家一定也可以想出更棒的應用方式！</p>
<p>謝謝收看。</p>
</div><div class="tags"><a href="/tags/PHP/">PHP</a><a href="/tags/Zend-Framework/">Zend Framework</a></div><div class="post-nav"><a href="/2010/05/26/1184/" class="pre"><i class="icon-previous">我的噗浪語錄</i></a><a href="/2010/05/24/1179/" class="next">關於學習技術這件事<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://jaceju.net"/></form></div><div class="widget"><div class="widget-title">分類</div></div><div class="widget"><div class="widget-title">標籤</div><div class="tagcloud"><a href="/tags/Compass/" style="font-size: 15px;">Compass</a> <a href="/tags/測試/" style="font-size: 15px;">測試</a> <a href="/tags/Web-開發/" style="font-size: 15px;">Web 開發</a> <a href="/tags/伺服器安裝與設定/" style="font-size: 15px;">伺服器安裝與設定</a> <a href="/tags/WebConf/" style="font-size: 15px;">WebConf</a> <a href="/tags/Selenium/" style="font-size: 15px;">Selenium</a> <a href="/tags/連結分享/" style="font-size: 15px;">連結分享</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/TDD/" style="font-size: 15px;">TDD</a> <a href="/tags/BDD/" style="font-size: 15px;">BDD</a> <a href="/tags/Refatoring/" style="font-size: 15px;">Refatoring</a> <a href="/tags/PHPConf-TW/" style="font-size: 15px;">PHPConf.TW</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Backbone-js/" style="font-size: 15px;">Backbone.js</a> <a href="/tags/RequireJS/" style="font-size: 15px;">RequireJS</a> <a href="/tags/JSDC/" style="font-size: 15px;">JSDC</a> <a href="/tags/心得感想/" style="font-size: 15px;">心得感想</a> <a href="/tags/Software-Development/" style="font-size: 15px;">Software Development</a> <a href="/tags/Octopress/" style="font-size: 15px;">Octopress</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/開發工具/" style="font-size: 15px;">開發工具</a> <a href="/tags/前端開發/" style="font-size: 15px;">前端開發</a> <a href="/tags/WebKit/" style="font-size: 15px;">WebKit</a> <a href="/tags/AngularJS/" style="font-size: 15px;">AngularJS</a> <a href="/tags/Grunt/" style="font-size: 15px;">Grunt</a> <a href="/tags/Yeoman/" style="font-size: 15px;">Yeoman</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/未分類/" style="font-size: 15px;">未分類</a> <a href="/tags/CoffeeScript/" style="font-size: 15px;">CoffeeScript</a> <a href="/tags/好站推薦/" style="font-size: 15px;">好站推薦</a> <a href="/tags/Zend-Framework/" style="font-size: 15px;">Zend Framework</a> <a href="/tags/程式開發/" style="font-size: 15px;">程式開發</a> <a href="/tags/ASP/" style="font-size: 15px;">ASP</a> <a href="/tags/資料庫/" style="font-size: 15px;">資料庫</a> <a href="/tags/好書推薦/" style="font-size: 15px;">好書推薦</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/好文推薦/" style="font-size: 15px;">好文推薦</a> <a href="/tags/Smarty/" style="font-size: 15px;">Smarty</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Windows/" style="font-size: 15px;">Windows</a> <a href="/tags/設計模式/" style="font-size: 15px;">設計模式</a> <a href="/tags/IE6/" style="font-size: 15px;">IE6</a> <a href="/tags/作品/" style="font-size: 15px;">作品</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/網路趣味/" style="font-size: 15px;">網路趣味</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/電腦知識/" style="font-size: 15px;">電腦知識</a> <a href="/tags/業界資訊/" style="font-size: 15px;">業界資訊</a> <a href="/tags/Mobile-開發/" style="font-size: 15px;">Mobile 開發</a> <a href="/tags/Titanium/" style="font-size: 15px;">Titanium</a> <a href="/tags/持續整合/" style="font-size: 15px;">持續整合</a> <a href="/tags/Refactoring/" style="font-size: 15px;">Refactoring</a> <a href="/tags/NetBeans/" style="font-size: 15px;">NetBeans</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/php-closure-testing/">在 PHPUnit 中測試需要 closure 的函式</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/27/web-testing-with-phpunit-mink/">利用 PHPUnit 與 Mink 來做 Web 測試</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/14/what-is-test/">這樣寫測試錯了嗎？</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/05/simple-refatoring-example-01/">邁向 PHP 重構之路 - 以 Laravel 程式碼片段為例</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/29/laravel-mailcatcher/">在 Laravel 上用 MailCatcher 發送測試信件</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/26/laravel-events-broadcasting/">Laravel 5.1 Events Broadcasting 實務練習</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/07/08/front-end-framework-summary/">幾個有興趣的前端框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/10/laravel-5-1/">Laravel 5.1 正式釋出</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/03/selenium-on-mac/">在 Mac OS X 上搭建 Selenium 測試環境</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/31/skilltree-tdd-3/">自動測試與 TDD 實務開發 - 上課心得 (下)</a></li></ul></div><div class="widget"><div class="widget-title">友站連結</div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">網站製作學習誌.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>