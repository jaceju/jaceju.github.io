<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>網站架構與部署策略筆記 | 網站製作學習誌</title>
  <meta name="author" content="Jace Ju">
  
  <meta name="description" content="這陣子為了公司的網站搞得自己焦頭爛額，其實自己很清楚在系統這個方面的涉獵並不深，但既然接了這個任務就得想辦法做好。
不過也因為不夠熟悉，讓系統出了很多問題。因此公司就請了我的好友 John 和他的師父來給我們一些系統層面的建議。這份筆記是主要是記錄我從他們口中所得到的心得，當然詳細的資訊還是需要花時間去研究與實作。而裡面有一些名詞是我沒有聽過的，所以可能記錯。
以下就是我個人覺得比較關鍵的部份：">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="網站架構與部署策略筆記"/>
  <meta property="og:site_name" content="網站製作學習誌"/>

  
    <meta property="og:image" content="http://i.imgur.com/LmHuRXl.jpg"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="網站製作學習誌" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">網站製作學習誌</a></h1>
  <h2><a href="/">記錄在開發網站時所學的一切</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-03-22T19:26:00.000Z"><a href="/2013/03/23/website-deploy-note/">2013-03-23</a></time>
      
      
  
    <h1 class="title">網站架構與部署策略筆記</h1>
  

    </header>
    <div class="entry">
      
        <p>這陣子為了公司的網站搞得自己焦頭爛額，其實自己很清楚在系統這個方面的涉獵並不深，但既然接了這個任務就得想辦法做好。</p>
<p>不過也因為不夠熟悉，讓系統出了很多問題。因此公司就請了我的好友 John 和他的師父來給我們一些系統層面的建議。這份筆記是主要是記錄我從他們口中所得到的心得，當然詳細的資訊還是需要花時間去研究與實作。而裡面有一些名詞是我沒有聽過的，所以可能記錯。</p>
<p>以下就是我個人覺得比較關鍵的部份：</p>
<a id="more"></a>
<h2 id="Virtual_Machine">Virtual Machine</h2><p>機器一來時，別急著在上面建立相關的 Web 服務或資料庫系統。</p>
<p>其實一台實體主機上面可以跑多個虛擬機器 (Virtual Machine, VM)  只要視機器等級切出適當的 VM 數量，這樣我們就能有效建立出一個多節點的系統。</p>
<p>另外 VM 也非常容易管理，像是安裝好第一個基本的 VM 系統後就隨時可以複製出新的 VM ，或是在某個 VM 爛掉時刪除它；這樣的方式就可以大大減少部署機器所花費的心力。</p>
<p>剛開始可以先使用 VMware vSphere 的免費版本，它有 Windows 版本的管理 UI 介面。</p>
<ul>
<li><a href="http://www.tenlong.com.tw/items/986868921X?item_id=437567" target="_blank" rel="external">VMware vSphere 5 企業建置教戰手扎</a></li>
</ul>
<h2 id="將_Log_紀錄獨立存放">將 Log 紀錄獨立存放</h2><p>Log 檔的處理也是一個很大的學問，比較好的方法是建立一台 syslogd 伺服器，然後把 log 都往這邊丟。這台伺服器等級不需要太好，但磁碟空間一定要夠大。</p>
<p>用 syslogd 的一個好處是，它是射後不理的，我們的服務只要向它丟 Log 即可，就算它掛了也不會影響我們的所有服務。</p>
<p>另外可以寫一個 Watch Dog 來分析 Log 中的惡意連結，當出現關鍵字的 Pattern 時，就記錄下這個 IP ，再利用 script 將這個 IP 發送到各節點上，將它擋下！</p>
<ul>
<li><a href="http://www.oreillynet.com/pub/a/sysadmin/2006/10/12/httpd-syslog.html" target="_blank" rel="external">Sending Apache httpd Logs to Syslog</a></li>
<li><a href="http://www.weithenn.org/cgi-bin/wiki.pl?Syslog-%E6%9E%B6%E8%A8%AD_Log_%E4%BC%BA%E6%9C%8D%E5%99%A8" target="_blank" rel="external">Syslog-架設 Log 伺服器</a></li>
</ul>
<h2 id="高併發要求">高併發要求</h2><p>靜態內容網站一定要使用 Reverse Proxy ，它可以提高網站的吞吐量。而網站是動態內容的話，就一定要想辦法讓它分散到各節點上。</p>
<p>而一般大流量網站通常不會有防火牆，而是用機海來應付。因為防火牆在大流量的狀況下，反而容易掛點。</p>
<h2 id="系統擴展">系統擴展</h2><p>服務與資料庫一定要考慮到橫向擴充，在任何時候都可以將一台機器加入或移除，而不影響到整體運作。</p>
<p>以前的架構是一台 Master 對多台 Slave ，而 Master 掛掉後就由所有的 Slave 推舉出新的 Master ，但這樣一來就不知道誰是 Master 了。</p>
<p>改良的做法是環狀結構，讓每一台機器都是下一台機器的 Master ，同時也是上一台機器的 Slave 。這樣如果其中一台掛點，系統就會主動再將這個環重新連結。</p>
<h2 id="兩層式的程式部署">兩層式的程式部署</h2><p>程式的部署需要自動化，而兩層式部署是比較簡單的方式，一層為 testing ，一層為 release 。</p>
<p>方法是在版本控制系統裡面將程式分成 testing 及 release 兩個分支， testing 分支是目前最新的程式碼，而 release 分支則是最穩定的程式碼。</p>
<p>在 testing 環境裡的程式碼必須都是可以執行無誤的，不可以有未完成的功能。當 testing 環境做完壓力測試後，管理者就可以程式碼放到 release 分支中。而所有的 production 都會主動查看 release 分支，當有新版本時就會自動更新。</p>
<p>不過兩層式部署還是有風險在，所以通常還會有 release candidate 版本的分支。有些大公司甚至做到了 16 層，也就是說所有的功能都必須經過 16 道檢驗才能上線。</p>
<h2 id="壓力測試">壓力測試</h2><p>利用 Switch 的 port mirroring 功能，將線上流量複製到準備要上線的機器，看它是否能撐住。通常這樣的壓力測試要跑三天至一週，確保系統的穩定性。</p>
<p>甚至也可以再讓多個 port 做 mirroring ，利用兩倍以上的流量來測試。這樣的目的主要是找出該機器的極限，也同時瞭解需要多少機器才能撐住預估的流量。</p>
<h2 id="不影響運作的系統更新">不影響運作的系統更新</h2><p>系統在更新程式前，會先把自己從 Load Balance 裡移下來，等確定沒問題後自動上線。</p>
<p>在資料庫系統方面，有些 Plugin 可以做到當 Slave 機器加入服務，與 Master 做同步資料的時候，先將自己隱藏起來，等到同步完成後，再讓服務啟動並上線。</p>
<h2 id="心得">心得</h2><p>據 John 的師父說，他們已經做到將這些行為完全自動化，並且只要在 Dashboard 上就可以看到所有服務的狀態；甚至後來還以紅綠燈配合聲音來做警示，聽完後我下巴都掉了。</p>
<p>事實上在人力有限，卻要管理幾十台機器的狀況下，這樣的做法才是身為一個技術人員應該去做的。</p>
<p>再次感謝 John 和他師父，讓我學到不少有關系統管理方面的知識。</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Web-開發/">Web 開發</a>, <a href="/tags/伺服器安裝與設定/">伺服器安裝與設定</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜尋">
    <input type="hidden" name="q" value="site:jaceju.net">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/ASP/">ASP</a><small>8</small></li>
  
    <li><a href="/tags/AngularJS/">AngularJS</a><small>1</small></li>
  
    <li><a href="/tags/Backbone-js/">Backbone.js</a><small>2</small></li>
  
    <li><a href="/tags/CSS/">CSS</a><small>22</small></li>
  
    <li><a href="/tags/CoffeeScript/">CoffeeScript</a><small>1</small></li>
  
    <li><a href="/tags/Compass/">Compass</a><small>1</small></li>
  
    <li><a href="/tags/Grunt/">Grunt</a><small>1</small></li>
  
    <li><a href="/tags/IE6/">IE6</a><small>1</small></li>
  
    <li><a href="/tags/JSDC/">JSDC</a><small>1</small></li>
  
    <li><a href="/tags/JavaScript/">JavaScript</a><small>46</small></li>
  
    <li><a href="/tags/Laravel/">Laravel</a><small>1</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>5</small></li>
  
    <li><a href="/tags/Mobile-開發/">Mobile 開發</a><small>1</small></li>
  
    <li><a href="/tags/MongoDB/">MongoDB</a><small>1</small></li>
  
    <li><a href="/tags/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/tags/NetBeans/">NetBeans</a><small>1</small></li>
  
    <li><a href="/tags/Octopress/">Octopress</a><small>1</small></li>
  
    <li><a href="/tags/PHP/">PHP</a><small>112</small></li>
  
    <li><a href="/tags/PHPConf-TW/">PHPConf.TW</a><small>1</small></li>
  
    <li><a href="/tags/RequireJS/">RequireJS</a><small>2</small></li>
  
    <li><a href="/tags/Selenium/">Selenium</a><small>1</small></li>
  
    <li><a href="/tags/Smarty/">Smarty</a><small>16</small></li>
  
    <li><a href="/tags/Software-Development/">Software Development</a><small>1</small></li>
  
    <li><a href="/tags/TDD/">TDD</a><small>2</small></li>
  
    <li><a href="/tags/Titanium/">Titanium</a><small>1</small></li>
  
    <li><a href="/tags/Web-開發/">Web 開發</a><small>25</small></li>
  
    <li><a href="/tags/WebConf/">WebConf</a><small>1</small></li>
  
    <li><a href="/tags/WebKit/">WebKit</a><small>1</small></li>
  
    <li><a href="/tags/Windows/">Windows</a><small>13</small></li>
  
    <li><a href="/tags/Yeoman/">Yeoman</a><small>1</small></li>
  
    <li><a href="/tags/Zend-Framework/">Zend Framework</a><small>57</small></li>
  
    <li><a href="/tags/jQuery/">jQuery</a><small>2</small></li>
  
    <li><a href="/tags/jQuery/">jQuery</a><small>1</small></li>
  
    <li><a href="/tags/伺服器安裝與設定/">伺服器安裝與設定</a><small>18</small></li>
  
    <li><a href="/tags/作品/">作品</a><small>13</small></li>
  
    <li><a href="/tags/單元測試/">單元測試</a><small>3</small></li>
  
    <li><a href="/tags/好文推薦/">好文推薦</a><small>2</small></li>
  
    <li><a href="/tags/好書推薦/">好書推薦</a><small>14</small></li>
  
    <li><a href="/tags/好站推薦/">好站推薦</a><small>11</small></li>
  
    <li><a href="/tags/心得感想/">心得感想</a><small>34</small></li>
  
    <li><a href="/tags/持續整合/">持續整合</a><small>2</small></li>
  
    <li><a href="/tags/未分類/">未分類</a><small>5</small></li>
  
    <li><a href="/tags/業界資訊/">業界資訊</a><small>5</small></li>
  
    <li><a href="/tags/程式開發/">程式開發</a><small>14</small></li>
  
    <li><a href="/tags/網路趣味/">網路趣味</a><small>3</small></li>
  
    <li><a href="/tags/設計模式/">設計模式</a><small>7</small></li>
  
    <li><a href="/tags/資料庫/">資料庫</a><small>5</small></li>
  
    <li><a href="/tags/連結分享/">連結分享</a><small>183</small></li>
  
    <li><a href="/tags/開發工具/">開發工具</a><small>8</small></li>
  
    <li><a href="/tags/電腦知識/">電腦知識</a><small>7</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Jace Ju
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-450710-8', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>