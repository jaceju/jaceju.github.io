<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇 | 網站製作學習誌</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇"><meta name="twitter:description" content="記錄在開發網站時所學的一切"><meta name="og:title" content="在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇"><meta name="og:site_name" content="網站製作學習誌"><meta name="og:description" content="記錄在開發網站時所學的一切"><meta name="og:type" content="article"><meta name="og:image" content=""></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇</h1><a id="logo" href="/.">網站製作學習誌</a><p class="description">記錄在開發網站時所學的一切</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首頁</i></a><a href="/archives/"><i class="fa fa-archive"> 所有文章</i></a><a href="/about/"><i class="fa fa-user"> 關於</i></a><a href="/atom.xml"><i class="fa fa-rss"> 訂閱</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇</h1><div class="post-meta">Nov 8, 2018</div><div class="post-content"><p>Laravel 的測試框架是基於 PHPUnit 上所建立出來的，而在 Laravel 5.5 之後，測試框架的功能也大幅地加強了。只不過在越來越複雜的專案規格下，我個人覺得 PHPUnit 在情境案例的描述能力上還是不太夠，最好可以用人們看得懂的語言；而目前能夠用自然語言來描述規格情境的，當然就是 <a href="https://cucumber.io/" target="_blank" rel="noopener">Cucumber</a> 的 <a href="http://behat.org/en/latest/user_guide/gherkin.html" target="_blank" rel="noopener">Gherkin</a> 語法了。</p>
<a id="more"></a>
<p>Cucumber 在 PHP 中的實作，就是 <a href="http://behat.org" target="_blank" rel="noopener">Behat</a> 這個 BDD 框架；雖然我很早就接觸過它了，但實際熟悉它則是在 <a href="https://skilltree.my/events/skilltree3" target="_blank" rel="noopener">91 哥的 TDD 課程</a>之後的自我練習裡。後來我看到 <a href="https://laracasts.com/" target="_blank" rel="noopener">Laracasts</a> 裡 Jeffrey Way 介紹他開發的 <a href="https://github.com/laracasts/Behat-Laravel-Extension" target="_blank" rel="noopener">Behat-Laravel-Extension</a> 可以將 Behat 整合到 Laravel 中，著實讓我開心了一陣子。</p>
<p>不久後我就透過 Behat-Laravel-Extension 在新開發的 API 專案裡整合了 Behat ，也確實體會到了 BDD 的優異之處；而同事也在接手這個專案時，因為透過自然語言所描述的情境，很快地掌握了整個專案的規格。我們就這樣透過 BDD 很快地把一個又一個的 API 生出來，兼顧了開發效率與規格文件。</p>
<p>不過這一兩年來 Behat-Laravel-Extension 已經很久沒人維護了，在我試圖升級專案的 Laravel 版本時，這個套件發生了版本不相容的問題；加上 Behat-Laravel-Extension 相依了許多我其實用不到的 Behat 延伸套件，因此找出一個更精簡的方案就勢在必行了。</p>
<h2 id="突破點"><a href="#突破點" class="headerlink" title="突破點"></a>突破點</h2><p>要把 Behat 用在 Laravel 的測試上，最大的問題是如何初始化 Application 。事實上 Behat 執行時只是把 <code>features/*.feature</code> 檔的 step definitions 和 <code>FeatureContext</code> 類別 (<code>features/bootstrap/FeatureContext.php</code>) 裡的 method 對應起來後，再跑遍每個 scenario 而已，所以初始化 Application 它並不負責。</p>
<p>不過如果各位有追蹤過 Laravel 專案的 <code>Illuminate\Foundation\Testing\TestCase</code> 這個類別的原始碼，你會發現它在 <code>setUp</code> 裡已經初始化了 Application ；而既然已經有類別把這件事做好，我是不是就可以直接拿它來用？沒錯！這就是我後來想到的方法。不過試了一陣子，陸陸續續有些問題我無法順利解決，導致這個作法一直被我塵封在腦海裡。</p>
<p>註：其實 Behat-Laravel-Extension 主要也是用來幫忙做初始化 Application 的工作。</p>
<p>就在前陣子我回頭思考這個問題時，想說是不是也有人有想過同樣的作法，結果還真的有！外國 Laravel 開發者 <a href="https://matthewdaly.co.uk/" target="_blank" rel="noopener">Matthew Daly</a> 早在一年多前就想到這個方法了： <a href="https://matthewdaly.co.uk/blog/2017/02/18/integrating-behat-with-laravel/" target="_blank" rel="noopener">Integrating Behat With Laravel</a> 。</p>
<p>以下我們就來實驗一下這個做法。</p>
<h2 id="在-Laravel-初始化-Behat-環境"><a href="#在-Laravel-初始化-Behat-環境" class="headerlink" title="在 Laravel 初始化 Behat 環境"></a>在 Laravel 初始化 Behat 環境</h2><p>首先我們要建立一個新的 Laravel 專案：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">laravel new Behat-in-Laravel</span><br><span class="line"><span class="built_in">cd</span> Behat-in-Laravel</span><br></pre></td></tr></table></figure>
<p>註：如果想在現有專案上直接來的話，可以省掉這個步驟，不過記得先將程式進版本控制系統。</p>
<p>安裝 Behat ：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer require behat/behat --dev</span><br></pre></td></tr></table></figure>
<p>接著用以下指令來初始化 Behat 的環境：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vendor/bin/behat --init</span><br></pre></td></tr></table></figure>
<p>這將會建立以下資料夾與檔案：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">+d features - place your *.feature files here</span><br><span class="line">+d features/bootstrap - place your context classes here</span><br><span class="line">+f features/bootstrap/FeatureContext.php - place your definitions, transformations and hooks here</span><br></pre></td></tr></table></figure>
<p>到這裡我們只是初始化環境而已，接下來編輯 <code>features/bootstrap/FeatureContext.php</code> 這個檔案：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Behat</span>\<span class="title">Behat</span>\<span class="title">Context</span>\<span class="title">Context</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Behat</span>\<span class="title">Gherkin</span>\<span class="title">Node</span>\<span class="title">PyStringNode</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Behat</span>\<span class="title">Gherkin</span>\<span class="title">Node</span>\<span class="title">TableNode</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Defines application features from the specific context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeatureContext</span> <span class="keyword">implements</span> <span class="title">Context</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initializes context.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Every scenario gets its own context instance.</span></span><br><span class="line"><span class="comment">     * You can also pass arbitrary arguments to the</span></span><br><span class="line"><span class="comment">     * context constructor through behat.yml.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>FeatureContext</code> 類別其實只有實作 <code>Behat\Behat\Context\Context</code> 這個介面，所以我們可以對它進行一些改造手術。</p>
<p>首先直接把 <code>FeatureContext</code> 類別繼承 Laravel 專案附帶的 <code>Tests\TestCase</code> 這個類別，並拿掉 <code>__construct</code> 建構子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Behat</span>\<span class="title">Behat</span>\<span class="title">Context</span>\<span class="title">Context</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Behat</span>\<span class="title">Gherkin</span>\<span class="title">Node</span>\<span class="title">PyStringNode</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Behat</span>\<span class="title">Gherkin</span>\<span class="title">Node</span>\<span class="title">TableNode</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tests</span>\<span class="title">TestCase</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Defines application features from the specific context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeatureContext</span> <span class="keyword">extends</span> <span class="title">TestCase</span> <span class="keyword">implements</span> <span class="title">Context</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下來就是重頭戲了，加上 <code>before</code> 及 <code>after</code> 兩個 public methods ，然後讓它們分別呼叫 <code>TestCase</code> 的 <code>setUp</code> 與 <code>tearDown</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeatureContext</span> <span class="keyword">extends</span> <span class="title">TestCase</span> <span class="keyword">implements</span> <span class="title">Context</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@BeforeScenario</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">before</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setUp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@AfterScenario</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">after</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tearDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>當然別忘了加上這兩個 hooks ： <code>@BeforeScenario</code> 及 <code>@AfterScenario</code> 。</p>
<p>之前失敗的原因主要是資料庫相關的環境變數及 migration ，而在前述的文章中 Matthew 是這樣解決的，我們照抄：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@BeforeScenario</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">before</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    putenv(<span class="string">'DB_CONNECTION=sqlite'</span>);</span><br><span class="line">    putenv(<span class="string">'DB_DATABASE=:memory:'</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setUp();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>註：文章 Matthew 是在 <code>__construct</code> 中做環境變數的初始化與 <code>setUp</code> ，理由可能是為了不重複初始化 Application ；但我之後會介紹更巧妙的方法，所以改寫在這邊。</p>
<p>那麼該怎麼做 migration 呢？文章中因為 Laravel 的版本是 <code>5.4</code> 的關係，所以是手動呼叫 artisan 指令來處理，不過現在我們有 <code>RefreshDatabase</code> 這個 trait 可以用了：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">RefreshDatabase</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Defines application features from the specific context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeatureContext</span> <span class="keyword">extends</span> <span class="title">TestCase</span> <span class="keyword">implements</span> <span class="title">Context</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">RefreshDatabase</span>;</span><br></pre></td></tr></table></figure>
<p>加入 <code>RefreshDatabase</code> trait 後， migration 相關的動作就會在 <code>setUp</code> 方法裡執行；當然所有 Laravel 測試框架提供的 trait 都可以這樣加入， <code>setUp</code> 方法都會幫你處理好。</p>
<p>這樣一來 Behat 就可以在 Laravel 測試框架的基礎上執行我們的測試，而不必再透過其他 extension 囉。</p>
<h2 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h2><p>接下來我直接來個超簡易範例，來確認一下這個做法是否有效。<strong>不過要事先提醒大家，這個範例僅是為了示範 Behat 整合到 Laravel 的開發流程，所以會省略掉 Behat 與 Laravel 的基礎介紹，以及實務開發時該注意的細節。</strong></p>
<p>假設專案有以下這個需求：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">提供使用者名稱、 Email 與密碼，並呼叫建立 User 的 API 後，會在資料庫建立一筆使用者的資料。</span><br></pre></td></tr></table></figure>
<p>經過規格討論後，我們用 Gherkin 語法建立了 <code>features/users-api.feature</code> 這個檔案，並包含了一個情境：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#language: zh-TW</span><br><span class="line"></span><br><span class="line">功能: User APIs</span><br><span class="line"></span><br><span class="line">  場景: 建立使用者</span><br><span class="line">    假定 API 網址為 &quot;/api/users&quot;</span><br><span class="line">    而且 API 附帶資料為</span><br><span class="line">      | name | email            | password |</span><br><span class="line">      | User | user@example.com | example  |</span><br><span class="line">    當 以 &quot;POST&quot; 方法要求 API</span><br><span class="line">    那麼 回傳狀態應為 201</span><br><span class="line">    而且 資料表 &quot;users&quot; 應有資料</span><br><span class="line">      | id | name | email            |</span><br><span class="line">      | 1  | User | user@example.com |</span><br></pre></td></tr></table></figure>
<p>先執行一次以下指令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vendor/bin/behat --append-snippets</span><br></pre></td></tr></table></figure>
<p>它會問我們要把 step definitions 放在哪裡：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">功能: User APIs</span><br><span class="line"></span><br><span class="line">  場景: 建立使用者                 <span class="comment"># features/users-api.feature:5</span></span><br><span class="line">    假定 API 網址為 <span class="string">"/api/users"</span></span><br><span class="line">    而且 API 附帶資料為</span><br><span class="line">      | name | email            | password |</span><br><span class="line">      | User | user@example.com | example  |</span><br><span class="line">    當 以 <span class="string">"POST"</span> 方法要求 API</span><br><span class="line">    那麼 回傳狀態應為 201</span><br><span class="line">    而且 資料表 <span class="string">"users"</span> 應有資料</span><br><span class="line">      | id | name | email            |</span><br><span class="line">      | 1  | User | user@example.com |</span><br><span class="line"></span><br><span class="line">1 scenario (1 undefined)</span><br><span class="line">5 steps (5 undefined)</span><br><span class="line">0m0.17s (21.79Mb)</span><br><span class="line"></span><br><span class="line"> &gt;&gt; default suite has undefined steps. Please choose the context to generate snippets:</span><br><span class="line"></span><br><span class="line">  [0] None</span><br><span class="line">  [1] FeatureContext</span><br></pre></td></tr></table></figure>
<p>選 <code>1</code> 把所有的 step definitions 都存在 <code>FeatureContext</code> 類別裡：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">u features/bootstrap/FeatureContext.php - `API 網址為 <span class="string">"/api/users"</span>` definition added</span><br><span class="line">u features/bootstrap/FeatureContext.php - `API 附帶資料為` definition added</span><br><span class="line">u features/bootstrap/FeatureContext.php - `以 <span class="string">"POST"</span> 方法要求 API` definition added</span><br><span class="line">u features/bootstrap/FeatureContext.php - `回傳狀態應為 201` definition added</span><br><span class="line">u features/bootstrap/FeatureContext.php - `資料表 <span class="string">"users"</span> 應有資料` definition added</span><br></pre></td></tr></table></figure>
<p>用編輯器打開 <code>features/bootstrap/FeatureContext.php</code> 後，就會看到以下新增的方法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Given</span> API 網址為 :arg1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apiWangZhiWei</span><span class="params">($arg1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Given</span> API 附帶資料為</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apiFuDaiZiLiaoWei</span><span class="params">(TableNode $table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@When</span> 以 :arg1 方法要求 API</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">yiFangFaYaoQiuApi</span><span class="params">($arg1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Then</span> 回傳狀態應為 :arg1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">huiChuanZhuangTaiYingWei</span><span class="params">($arg1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Then</span> 資料表 :arg1 應有資料</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ziLiaoBiaoYingYouZiLiao</span><span class="params">($arg1, TableNode $table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>雖然 <code>behat --append-snippets</code> 所產生的方法在 annonation 會保留原來的中文句子，但卻會把中文的 step definition 轉換成拼音式的方法名稱，因此我們需要將每個方法的名稱換成可讀性高的名稱，同時調整參數名稱：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Given</span> API 網址為 :apiUrl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $apiUrl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apiUrl</span><span class="params">(string $apiUrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Given</span> API 附帶資料為</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> TableNode $table</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apiBody</span><span class="params">(TableNode $table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@When</span> 以 :method 方法要求 API</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $method</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span><span class="params">(string $method)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Then</span> 回傳狀態應為 :statusCode</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $statusCode</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assertStatus</span><span class="params">(int $statusCode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Then</span> 資料表 :tableName 應有資料</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $tableName</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> TableNode $table</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assertTableRecordExisted</span><span class="params">(string $tableName, TableNode $table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> PendingException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然後再次執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vendor/bin/behat --append-snippets</span><br></pre></td></tr></table></figure>
<p>就不會再次詢問是不是要加入 snippets ，而是希望你把 step definitions 的方法實作出來：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">功能: User APIs</span><br><span class="line"></span><br><span class="line">  場景: 建立使用者                 <span class="comment"># features/users-api.feature:5</span></span><br><span class="line">    假定 API 網址為 <span class="string">"/api/users"</span> <span class="comment"># FeatureContext::apiUrl()</span></span><br><span class="line">      TODO: write pending definition</span><br><span class="line">    而且 API 附帶資料為            <span class="comment"># FeatureContext::apiBody()</span></span><br><span class="line">      | name | email            | password |</span><br><span class="line">      | User | user@example.com | example  |</span><br><span class="line">    當 以 <span class="string">"POST"</span> 方法要求 API     <span class="comment"># FeatureContext::request()</span></span><br><span class="line">    那麼 回傳狀態應為 201           <span class="comment"># FeatureContext::assertStatus()</span></span><br><span class="line">    而且 資料表 <span class="string">"users"</span> 應有資料     <span class="comment"># FeatureContext::assertTableRecordExisted()</span></span><br><span class="line">      | id | name | email            |</span><br><span class="line">      | 1  | User | user@example.com |</span><br><span class="line"></span><br><span class="line">1 scenario (1 pending)</span><br><span class="line">5 steps (1 pending, 4 skipped)</span><br><span class="line">0m0.18s (21.82Mb)</span><br></pre></td></tr></table></figure>
<p>接下來把方法實作補上：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> $apiUrl = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> $apiBody = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> \Illuminate\Foundation\Testing\TestResponse</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> $response;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Given</span> API 網址為 :apiUrl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $apiUrl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apiUrl</span><span class="params">(string $apiUrl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;apiUrl = $apiUrl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Given</span> API 附帶資料為</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> TableNode $table</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apiBody</span><span class="params">(TableNode $table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;apiBody = $table-&gt;getHash()[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@When</span> 以 :method 方法要求 API</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $method</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">request</span><span class="params">(string $method)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;response = <span class="keyword">$this</span>-&gt;json($method, <span class="keyword">$this</span>-&gt;apiUrl, <span class="keyword">$this</span>-&gt;apiBody);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Then</span> 回傳狀態應為 :statusCode</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $statusCode</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assertStatus</span><span class="params">(int $statusCode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;response-&gt;assertStatus($statusCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Then</span> 資料表 :tableName 應有資料</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $tableName</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> TableNode $table</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assertTableRecordExisted</span><span class="params">(string $tableName, TableNode $table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;assertDatabaseHas($tableName, $table-&gt;getHash()[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vendor/bin/behat --append-snippets</span><br></pre></td></tr></table></figure>
<p>就會出現：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">功能: User APIs</span><br><span class="line"></span><br><span class="line">  場景: 建立使用者                 <span class="comment"># features/users-api.feature:5</span></span><br><span class="line">    假定 API 網址為 <span class="string">"/api/users"</span> <span class="comment"># FeatureContext::apiUrl()</span></span><br><span class="line">    而且 API 附帶資料為            <span class="comment"># FeatureContext::apiBody()</span></span><br><span class="line">      | name | email            | password |</span><br><span class="line">      | User | user@example.com | example  |</span><br><span class="line">    當 以 <span class="string">"POST"</span> 方法要求 API     <span class="comment"># FeatureContext::request()</span></span><br><span class="line">    那麼 回傳狀態應為 201           <span class="comment"># FeatureContext::assertStatus()</span></span><br><span class="line">      Expected status code 201 but received 404.</span><br><span class="line">      Failed asserting that <span class="literal">false</span> is <span class="literal">true</span>.</span><br><span class="line">    而且 資料表 <span class="string">"users"</span> 應有資料     <span class="comment"># FeatureContext::assertTableRecordExisted()</span></span><br><span class="line">      | id | name | email            |</span><br><span class="line">      | 1  | User | user@example.com |</span><br><span class="line"></span><br><span class="line">--- Failed scenarios:</span><br><span class="line"></span><br><span class="line">    features/users-api.feature:5</span><br><span class="line"></span><br><span class="line">1 scenario (1 failed)</span><br><span class="line">5 steps (3 passed, 1 failed, 1 skipped)</span><br><span class="line">0m0.19s (22.82Mb)</span><br></pre></td></tr></table></figure>
<p>剩下的就是完成 API 程式碼實作啦，這裡就不多做介紹了，完成的程式碼請到 <a href="https://github.com/jaceju-tutorial-examples/behat-in-laravel-basic" target="_blank" rel="noopener">GitHub</a> 上查看。</p>
<p>下一篇我會再介紹稍微進階的做法。</p>
</div><div class="tags"><a href="/tags/測試/">測試</a><a href="/tags/Laravel/">Laravel</a></div><div class="post-nav"><a class="pre" href="/behat-in-laravel-advance/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 進階篇</a><a class="next" href="/composer-replace/">理解 composer.json 的 replace</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://jaceju.net"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分類</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 標籤</i></div><div class="tagcloud"><a href="/tags/設計模式/" style="font-size: 15px;">設計模式</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/ASP/" style="font-size: 15px;">ASP</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Web-開發/" style="font-size: 15px;">Web 開發</a> <a href="/tags/好書推薦/" style="font-size: 15px;">好書推薦</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/心得感想/" style="font-size: 15px;">心得感想</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/程式開發/" style="font-size: 15px;">程式開發</a> <a href="/tags/伺服器安裝與設定/" style="font-size: 15px;">伺服器安裝與設定</a> <a href="/tags/TDD/" style="font-size: 15px;">TDD</a> <a href="/tags/測試/" style="font-size: 15px;">測試</a> <a href="/tags/Selenium/" style="font-size: 15px;">Selenium</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/Refactoring/" style="font-size: 15px;">Refactoring</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/how-i-built-my-side-project/">我如何從需求出發到完成一個專案</a></li><li class="post-list-item"><a class="post-list-link" href="/function-name-must-be-a-string-in-laravel-testing/">Laravel 執行測試時出現 Function name must be a string</a></li><li class="post-list-item"><a class="post-list-link" href="/what-is-essential-to-frontend-engineers/">身為前端工程師，對你來說，你認為最重要的是什麼？</a></li><li class="post-list-item"><a class="post-list-link" href="/my-2018/">我的 2018 年</a></li><li class="post-list-item"><a class="post-list-link" href="/behat-in-laravel-advance/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 進階篇</a></li><li class="post-list-item"><a class="post-list-link" href="/behat-in-laravel/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇</a></li><li class="post-list-item"><a class="post-list-link" href="/composer-replace/">理解 composer.json 的 replace</a></li><li class="post-list-item"><a class="post-list-link" href="/steps-of-refactoring-or-rebuilding/">重構或重寫 Legacy code 的幾個階段</a></li><li class="post-list-item"><a class="post-list-link" href="/refactor-or-rebuild/">面對 Legacy Code ，該重構還是重寫？</a></li><li class="post-list-item"><a class="post-list-link" href="/to-test-the-detail-or-to-test-the-result/">測試該驗證結果還是該驗證細節</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友站連結</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">網站製作學習誌.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>