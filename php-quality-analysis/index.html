<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>分析 PHP 程式碼品質 | 網站製作學習誌</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="分析 PHP 程式碼品質"><meta name="twitter:description" content="記錄在開發網站時所學的一切"><meta name="og:title" content="分析 PHP 程式碼品質"><meta name="og:site_name" content="網站製作學習誌"><meta name="og:description" content="記錄在開發網站時所學的一切"><meta name="og:type" content="article"><meta name="og:image" content=""></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">分析 PHP 程式碼品質</h1><a id="logo" href="/.">網站製作學習誌</a><p class="description">記錄在開發網站時所學的一切</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首頁</i></a><a href="/archives/"><i class="fa fa-archive"> 所有文章</i></a><a href="/about/"><i class="fa fa-user"> 關於</i></a><a href="/atom.xml"><i class="fa fa-rss"> 訂閱</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">分析 PHP 程式碼品質</h1><div class="post-meta">Jan 11, 2017</div><div class="post-content"><p>前兩天 Laravel 老爸 Taylor 分享了他對幾個知名的 framework 所做的<a href="https://medium.com/@taylorotwell/measuring-code-complexity-64356da605f9#.i9ah5inwx" target="_blank" rel="noopener">程式碼品質分析</a>，引起了社群很大的<a href="https://www.facebook.com/groups/laravel.tw/permalink/1200376173364763/" target="_blank" rel="noopener">討論</a>。</p>
<p>因此，我想藉機分享一下：</p>
<ul>
<li>如何對 PHP 程式碼做分析。</li>
<li>分析出來的數值有什麼意義。</li>
</ul>
<!-- more -->
<h2 id="PHP-程式碼分析工具"><a href="#PHP-程式碼分析工具" class="headerlink" title="PHP 程式碼分析工具"></a>PHP 程式碼分析工具</h2><p>PHP 程式碼分析工具其實有很多，但一一安裝其實很花時間。這裡我推薦一個套件： <a href="https://github.com/EdgedesignCZ/phpqa" target="_blank" rel="noopener">PHPQA</a> ，它已經把以下常用的 PHP 程式碼分析工具整合在一個命令列裡了：</p>
<ul>
<li><a href="https://github.com/sebastianbergmann/phploc" target="_blank" rel="noopener">phploc</a> - 測試 PHP 專案的大小 (即程式碼行數等資訊)</li>
<li><a href="https://github.com/sebastianbergmann/phpcpd" target="_blank" rel="noopener">phpcpd</a> - 重複程式偵測</li>
<li><a href="https://github.com/squizlabs/PHP_CodeSniffer" target="_blank" rel="noopener">phpcs</a> - 程式碼風格檢查</li>
<li><a href="https://github.com/pdepend/pdepend" target="_blank" rel="noopener">pdepend</a> - 程式碼依賴度檢查</li>
<li><a href="https://github.com/phpmd/phpmd" target="_blank" rel="noopener">phpmd</a> - 找出專案複雜度過高的程式碼</li>
<li><a href="https://github.com/Halleck45/PhpMetrics" target="_blank" rel="noopener">phpmetrics</a> - PHP 程式碼靜態分析</li>
<li><a href="https://github.com/JakubOnderka/PHP-Parallel-Lint" target="_blank" rel="noopener">parallel-lint</a> - 同時檢查多個 PHP 檔案的語法</li>
<li><a href="https://github.com/phpstan/phpstan" target="_blank" rel="noopener">phpstan</a> - 在還沒執行程式前就找到可能的 bug (結果它本身也有 bug )</li>
</ul>
<p>PHPQA 的安裝方式很簡單，用 composer 全域安裝即可：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer global require edgedesign/phpqa --update-no-dev</span><br></pre></td></tr></table></figure>
<p>不過這時候安裝的 <code>phpcpd 2.0.4</code> 會有<a href="https://github.com/sebastianbergmann/phpcpd/issues/132" target="_blank" rel="noopener">問題</a>，所以要安裝 <code>dev-master</code> 版：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ composer global require sebastian/phpcpd:dev-master</span><br></pre></td></tr></table></figure>
<p>現在可以確認一下是否有安裝成功了，執行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ phpqa tools</span><br><span class="line">+---------------+------------+----------------------------------------------+</span><br><span class="line">| Tool          | Version    | Authors                                      |</span><br><span class="line">+---------------+------------+----------------------------------------------+</span><br><span class="line">| phpqa         | 1.9.1      | Zdenek Drahos                                |</span><br><span class="line">| phpmetrics    | 1.10.0     | Jean-François Lépine                         |</span><br><span class="line">| phploc        | 3.0.1      | Sebastian Bergmann                           |</span><br><span class="line">| phpcs         | 2.7.1      | Greg Sherwood                                |</span><br><span class="line">| phpmd         | 2.5.0      | Manuel Pichler,Other contributors,Marc Würth |</span><br><span class="line">| pdepend       | 2.3.2      |                                              |</span><br><span class="line">| phpcpd        | dev-master | Sebastian Bergmann                           |</span><br><span class="line">| parallel-lint | 0.9.2      | Jakub Onderka                                |</span><br><span class="line">+---------------+------------+----------------------------------------------+</span><br></pre></td></tr></table></figure>
<blockquote>
<p>記得確認一下 <code>$HOME/.composer/vendor/bin</code> 有在你的 <code>$PATH</code> 環境變數裡，不然沒辦法執行安裝好的指令。</p>
</blockquote>
<h2 id="用-PHPQA-產生分析報表"><a href="#用-PHPQA-產生分析報表" class="headerlink" title="用 PHPQA 產生分析報表"></a>用 PHPQA 產生分析報表</h2><p>現在可以找一個 PHP 專案來試試 <code>phpqa</code> ，這裡我直接用一個新的 Laravel 專案來實驗：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ laravel new qa-example</span><br><span class="line">$ <span class="built_in">cd</span> qa-example</span><br></pre></td></tr></table></figure>
<p>然後執行 <code>phpqa</code> 來跑出報表：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ phpqa --ignoredDirs vendor --report</span><br></pre></td></tr></table></figure>
<p><code>--ignoredDirs</code> 是指排除掉指定的目錄，也可以改用 <code>--analyzedDirs</code> 來分析特定的目錄；目錄名稱之間可以用逗號 (<code>,</code>) 隔開。</p>
<p>執行結果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">... (略) ...</span><br><span class="line">[phpqa]</span><br><span class="line">+---------------+----------------+--------------+--------+---------------------------+</span><br><span class="line">| Tool          | Allowed Errors | Errors count | Is OK? | HTML report               |</span><br><span class="line">+---------------+----------------+--------------+--------+---------------------------+</span><br><span class="line">| phpmetrics    |                |              | ✓      | build//phpmetrics.html    |</span><br><span class="line">| phploc        |                |              | ✓      | build//phploc.html        |</span><br><span class="line">| phpcs         |                | 26           | ✓      | build//phpcs.html         |</span><br><span class="line">| phpmd         |                | 4            | ✓      | build//phpmd.html         |</span><br><span class="line">| pdepend       |                |              | ✓      | build//pdepend.html       |</span><br><span class="line">| phpcpd        |                | 0            | ✓      | build//phpcpd.html        |</span><br><span class="line">| parallel-lint |                | 0            | ✓      | build//parallel-lint.html |</span><br><span class="line">+---------------+----------------+--------------+--------+---------------------------+</span><br><span class="line">| phpqa         |                | 30           | ✓      | build//phpqa.html         |</span><br><span class="line">+---------------+----------------+--------------+--------+---------------------------+</span><br><span class="line"></span><br><span class="line">[phpqa] No failed tools</span><br></pre></td></tr></table></figure>
<p>這樣 <code>phpqa</code> 就會在專案下建立 <code>build</code> 資料夾，裡面就會放著所有分析報表；我們只需要打開 <code>build/phpqa.html</code> 就可以看到所有的報表了。</p>
<p><img src="../resources/phpqa/phpqa.png" alt="phpqa.html"></p>
<p>更好的做法是把它們整合到 CI 自動化流程裡，這樣每一次 push 程式碼後就可以自動產生這些報表。</p>
<p>另外我們也可以在專案目錄下建立一個 <a href="https://github.com/EdgedesignCZ/phpqa/blob/master/.phpqa.yml" target="_blank" rel="noopener"><code>.phpqa.yml</code></a> 設定檔，來微調這些工具的設定。例如：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">phpcs:</span></span><br><span class="line"><span class="attr">    standard:</span> <span class="string">PSR2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">phpmd:</span></span><br><span class="line"><span class="attr">    standard:</span> <span class="string">app/phpmd.xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">phpcpd:</span></span><br><span class="line"><span class="attr">    minLines:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    minTokens:</span> <span class="number">70</span></span><br><span class="line"></span><br><span class="line"><span class="attr">phpstan:</span></span><br><span class="line"><span class="attr">    level:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># https://github.com/phpstan/phpstan#configuration</span></span><br><span class="line">    <span class="comment"># standard: tests/.travis/phpstan.neon</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># paths are relative to .phpqa.yml, so don't copy-paste this section if you don't have custom templates</span></span><br><span class="line"><span class="attr">report:</span></span><br><span class="line"><span class="attr">    phploc:</span> <span class="string">app/report/phploc.xsl</span></span><br><span class="line"><span class="attr">    phpcpd:</span> <span class="string">app/report/phpcpd.xsl</span></span><br><span class="line"><span class="attr">    phpcs:</span> <span class="string">app/report/phpcs.xsl</span></span><br><span class="line"><span class="attr">    pdepend:</span> <span class="string">app/report/pdepend.xsl</span></span><br><span class="line"><span class="attr">    phpmd:</span> <span class="string">app/report/phpmd.xsl</span></span><br></pre></td></tr></table></figure>
<p>在執行 <code>phpqa</code> 時，可以用 <code>--config</code> 來指定：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ phpqa --config=./.phpqa.yml --report</span><br></pre></td></tr></table></figure>
<h2 id="各報表的意義"><a href="#各報表的意義" class="headerlink" title="各報表的意義"></a>各報表的意義</h2><p>這裡僅簡單介紹每個報表的意義，詳細的介紹就請大家參考官方說明。</p>
<p><code>PhpMetrics report</code> 本身就包含了多種面向的分析，像是複雜度、相依性、程式碼大小等資訊，官網有介紹<a href="http://www.phpmetrics.org/documentation/how-to-read-report.html" target="_blank" rel="noopener">如何解讀</a>。在 <code>Explore</code> 頁籤上可以瀏覽到所有檔案的分析指標，這些指標也可以從官方網站上找到<a href="http://www.phpmetrics.org/documentation/index.html" target="_blank" rel="noopener">它們的說明</a>。</p>
<p><code>phploc report</code> 主要是列出專案的程式碼大小，但會細分出一些資訊；比較重要的資訊像是：邏輯總行數 (LLOC) 、最大類別行數 (Maximum Class Length) 、最大函式行數 (Maximum Method Length) 。通常類別行數或函式行數小表示有較佳的程式碼品質，因為小類別與小函式較容易專注在一件事上，可讀性與可維護性都會好一些。</p>
<p><code>phpcs report</code> 主要會列出每支 PHP 檔中不符合程式碼風格規範的地方，預設的程式碼規範是 PSR2 。</p>
<p><code>phpmd report</code> 會列出一些糟糕的程式碼，像是定義後卻沒有用到的變數、或是變數名稱過於簡略等。詳細的規則可以參考官方手冊的 <a href="https://phpmd.org/rules/index.html" target="_blank" rel="noopener">Rules</a> 說明。</p>
<p><code>PDepend report</code> 也跟 <code>PhpMetrics</code> 一樣同時包含了多種指標，不同的是它對每個類別所相依的類別會有比較清楚的列表，而不是用連接線來表示。這裡的各項指標主要是影響類別的穩定度與耦合度，例如抽象類依賴太多實體類別，那麼耦合度就會很高；如果有太多實體類別的互動，那麼穩定度就會下降。<a href="https://www.testwo.com/blog/7640" target="_blank" rel="noopener">這篇文章</a> 有更詳細的說明，值得一讀。</p>
<p><code>phpcpd report</code> 會列出有複製貼上程式碼的檔案以及重複出現的行數。 <code>phpcpd</code> 也是 <code>PHPUnit</code> 老爸的作品。</p>
<p><code>parallel-lint</code> 會列出有 PHP 語法錯誤的檔案，預設會用當下的 PHP 版本來驗證。</p>
<h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><p>就像在平常開發時，我們會從程式碼測試覆蓋率報表中看出還有沒有值得加強測試的部份；而利用 phpqa 所分析出來的這些報表其實也是讓我們瞭解目前程式碼的現狀，進而從這些指標找出可能有問題的地方來加以重構。</p>
<p>希望這樣的介紹可以讓大家開始用這些工具來時時關心自己的程式碼品質，早一步分析出程式碼中潛藏的問題，這樣一來我們就可以把時間花在值得修改的地方。</p>
</div><div class="tags"><a href="/tags/PHP/">PHP</a></div><div class="post-nav"><a class="pre" href="/to-test-the-detail-or-to-test-the-result/">測試該驗證結果還是該驗證細節</a><a class="next" href="/spotify-engineering-culture/">很值得一看的 Spotify 的工程文化</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://jaceju.net"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分類</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 標籤</i></div><div class="tagcloud"><a href="/tags/好書推薦/" style="font-size: 15px;">好書推薦</a> <a href="/tags/測試/" style="font-size: 15px;">測試</a> <a href="/tags/TDD/" style="font-size: 15px;">TDD</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/心得感想/" style="font-size: 15px;">心得感想</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/ASP/" style="font-size: 15px;">ASP</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Web-開發/" style="font-size: 15px;">Web 開發</a> <a href="/tags/Selenium/" style="font-size: 15px;">Selenium</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/設計模式/" style="font-size: 15px;">設計模式</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/程式開發/" style="font-size: 15px;">程式開發</a> <a href="/tags/伺服器安裝與設定/" style="font-size: 15px;">伺服器安裝與設定</a> <a href="/tags/Refactoring/" style="font-size: 15px;">Refactoring</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/讀書心得/" style="font-size: 15px;">讀書心得</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/review-reengineering-legacy-software/">《遺留系統重建實戰》整理與心得</a></li><li class="post-list-item"><a class="post-list-link" href="/integrate-vue-cli-into-laravel/">在 Laravel 專案中整合 Vue CLI</a></li><li class="post-list-item"><a class="post-list-link" href="/how-i-built-my-side-project/">我如何從需求出發到完成一個專案</a></li><li class="post-list-item"><a class="post-list-link" href="/function-name-must-be-a-string-in-laravel-testing/">Laravel 執行測試時出現 Function name must be a string</a></li><li class="post-list-item"><a class="post-list-link" href="/what-is-essential-to-frontend-engineers/">身為前端工程師，對你來說，你認為最重要的是什麼？</a></li><li class="post-list-item"><a class="post-list-link" href="/my-2018/">我的 2018 年</a></li><li class="post-list-item"><a class="post-list-link" href="/behat-in-laravel-advance/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 進階篇</a></li><li class="post-list-item"><a class="post-list-link" href="/behat-in-laravel/">在 Laravel 中使用 Behat 來加強測試的可讀性 - 基礎篇</a></li><li class="post-list-item"><a class="post-list-link" href="/composer-replace/">理解 composer.json 的 replace</a></li><li class="post-list-item"><a class="post-list-link" href="/steps-of-refactoring-or-rebuilding/">重構或重寫 Legacy code 的幾個階段</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友站連結</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">網站製作學習誌.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>