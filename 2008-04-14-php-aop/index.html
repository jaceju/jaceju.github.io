<!DOCTYPE html><html lang="zh-tw"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>[PHP] 在 PHP5 中實作 AOP 的概念 | 網站製作學習誌</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">[PHP] 在 PHP5 中實作 AOP 的概念</h1><a id="logo" href="/.">網站製作學習誌</a><p class="description">記錄在開發網站時所學的一切</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> 首頁</i></a><a href="/archives/"><i class="icon-archive"> 所有文章</i></a><a href="/about/"><i class="icon-about"> 關於</i></a><a href="/atom.xml"><i class="icon-rss"> 訂閱</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">[PHP] 在 PHP5 中實作 AOP 的概念</h1><div class="post-meta">2008-04-14</div><div class="post-content"><p>這篇積在我電腦裡很久了，一直沒公開…這次趁著要幫我的 Library 加料，順便拿出來分享一下心得。</p>
<a id="more"></a>
<h2 id="什麼是_AOP">什麼是 AOP</h2><p> AOP 全名為 Aspect-Oriented Programming ，基本的觀念可以參考良葛格的 AOP 入門：</p>
<li><span id="text145561"><a href="http://caterpillar.onlyfun.net/Gossip/SpringGossip/FromProxyToAOP.html" target="_blank" rel="external">從代理機制初探 AOP</a></span></li><br><li><span><a href="http://caterpillar.onlyfun.net/Gossip/SpringGossip/DynamicProxy.html" target="_blank" rel="external">動態代理</a></span></li><br><li><span><a href="http://caterpillar.onlyfun.net/Gossip/SpringGossip/AOPConcept.html" target="_blank" rel="external">AOP 觀念與術語</a></span></li>


<p>這裡我簡單提一下 AOP 的基本想法：</p>
<p>假設當我們呼叫物件的某些方法 (或是<strong>業務流程</strong>) 之後，會想要把相關的資訊記錄到 log 檔裡，我們也許會這樣寫：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Test</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 某個方法</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">doSomething</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="comment">// 建立 Log 物件</span></span><br><span class="line">        <span class="variable">$logger</span> = <span class="keyword">new</span> Log();</span><br><span class="line">        <span class="comment">// 寫入前置 Log</span></span><br><span class="line">        <span class="variable">$logger</span>-&gt;save(<span class="string">'before do something.'</span>);</span><br><span class="line">        <span class="comment">// 主要的動作</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 寫入 Log</span></span><br><span class="line">        <span class="variable">$logger</span>-&gt;save(<span class="string">'before do something.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可是如果今天這個記錄 log 的這個動作只是臨時的，或是在未來可能會需要再加入不同的動作時 (例如寄信) ，難道我們還要在原有方法的程式碼裡修修改改嗎？有沒有什麼方式能協助我們動態地把記錄的動作插在原有動作之後呢？</p>
<p>AOP 就是從這個角度所延伸出來的一種觀念，它能協助我們在不侵入原有類別程式碼的狀況下，動態地為類別方法新增額外的權責；簡單來說， AOP 主要的目的就是<strong>切入類別原有方法執行之前或之後，並安插我們想要執行的動作</strong>。</p>
<p>註： IT 界似乎很喜歡發明深奧的名詞來詮釋一個簡單的概念，然後像我這樣不學無術的開發者就常被唬得一楞一楞的。</p>
<h2 id="AOP_和_Decorator">AOP 和 Decorator</h2><p>先介紹幾篇實作 AOP 的文章：</p>
<ul>
<li><a href="http://racklin.blogspot.com/2007/08/aop-for-jquery.html" target="_blank" rel="external">AOP for jQuery</a></li>
<li><a href="http://blog.jonnay.net/archives/637-Aspect-Oriented-Programming-in-PHP-as-a-contrast-to-other-languages..html" target="_blank" rel="external">Aspect Oriented Programming in PHP as a contrast to other languages.</a></li>
<li><a href="http://wiki.jonnay.net/bunny/bunnyaspectsphp" target="_blank" rel="external">Bunny Aspects</a></li>
<li><a href="http://jaxn.org/article/2004/10/16/more-on-aspect-oriented-php/" target="_blank" rel="external">More on Aspect Oriented PHP</a></li>
<li><a href="http://hi.baidu.com/thinkinginlamp/blog/item/864a0ef46d93b86eddc474f3.html" target="_blank" rel="external">在PHP里利用魔术方法实现准AOP</a></li>
<li><a href="http://sushener.spaces.live.com/blog/cns!BB54050A5CFAFCDD!546.entry" target="_blank" rel="external">AOP在PHP中的实现方式</a></li>
<li><a href="http://www.phpclasses.org/browse/package/2633.html" target="_blank" rel="external">Class: AOP Library for PHP</a></li>
</ul>
<p>其實一開始我以為 AOP 和 Decorator 模式在 PHP 上的實作方式是差不多的，不過實際上還有是些許的差別。</p>
<p>一般在 Decorator 模式中，具體類別和 Wrapper 類別都會有個共同的祖先，亦即一個抽象類別或介面，因此所產生出來的物件對 Client 程式來說，其抽象型態可以說是一樣的。</p>
<p>但是在 AOP in PHP 中，我們必須透過一個代理類別來切入原有的類別方法裡，雖然這個代理類別也能夠提供原有類別中的所有方法，但是實際上它卻已經失去了與原有類別所擁有的抽象型態了。</p>
<h2 id="用_PHP_實作_AOP">用 PHP 實作 AOP</h2><p>首先我們來看看還沒有切入任何事件的目標類別：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Test class</span><br><span class="line"> *</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClass</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Method 1</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $message</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method1</span><span class="params">(<span class="variable">$message</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n"</span>, <span class="keyword">__METHOD__</span>, <span class="string">":\n"</span>, <span class="variable">$message</span>, <span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Method 2</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> int</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method2</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n"</span>, <span class="keyword">__METHOD__</span>, <span class="string">":\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> rand(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Method 3</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@throws</span> Exception</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">method3</span><span class="params">()</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"\n"</span>, <span class="keyword">__METHOD__</span>, <span class="string">":\n"</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Test Exception.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這個類別提供了三個方法，其中 method1 和 method2 只是簡單的顯示資料而已，而 method3 則會丟出一個異常。</p>
<p>另外我們需要一個 Log 類別：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Log</span><br><span class="line"> *</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Log</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * log message</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $message</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(<span class="variable">$message</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$message</span>, <span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這個 Log 類別只提供一個 save() 方法，以顯示 log 訊息。</p>
<p>現在我們要完成的目標如下：</p>
<ul>
<li><p>在 method1 執行前呼叫 Log::save() 。</p>
</li>
<li><p>在 method2 執行後呼叫 Log::save() 。</p>
</li>
<li><p>在 method3 發生異常時呼叫 Log::save() 。</p>
</li>
</ul>
<p>這裡我用很簡單的方式來做，那就是直接使用一個 Aspect 類別：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Aspect</span><br><span class="line"> *</span><br><span class="line"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Aspect</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Name of target class</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@var</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_className</span> = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Target object</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@var</span> object</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_target</span> = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Event callback</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@var</span> array</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_eventCallbacks</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Add object</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> object $target</span><br><span class="line">     * <span class="doctag">@return</span> Aspect</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">addObject</span><span class="params">(<span class="variable">$target</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Aspect(<span class="variable">$target</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Contructor</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> object $target</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(<span class="variable">$target</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_object(<span class="variable">$target</span>)) &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;_target = <span class="variable">$target</span>;</span><br><span class="line">            <span class="variable">$this</span>-&gt;_className = get_class(<span class="variable">$this</span>-&gt;_target);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Register event</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $eventName</span><br><span class="line">     * <span class="doctag">@param</span> string $methodName</span><br><span class="line">     * <span class="doctag">@param</span> callback $callback</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_registerEvent</span><span class="params">(<span class="variable">$eventName</span>, <span class="variable">$methodName</span>, <span class="variable">$callback</span>, <span class="variable">$args</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$this</span>-&gt;_eventCallbacks[<span class="variable">$methodName</span>])) &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;_eventCallbacks[<span class="variable">$methodName</span>] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!is_callable(<span class="keyword">array</span>(<span class="variable">$this</span>-&gt;_target, <span class="variable">$methodName</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(get_class(<span class="variable">$this</span>-&gt;_target) . <span class="string">'::'</span> . <span class="variable">$methodName</span> . <span class="string">' is not exists.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (is_callable(<span class="variable">$callback</span>)) &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;_eventCallbacks[<span class="variable">$methodName</span>](<span class="variable">$eventName</span>) = <span class="keyword">array</span>(<span class="variable">$callback</span>, <span class="variable">$args</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$callbackName</span> = Aspect::getCallbackName(<span class="variable">$callback</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="variable">$callbackName</span> . <span class="string">' is not callable.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Register 'before' handler</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $methodName</span><br><span class="line">     * <span class="doctag">@param</span> callback $callback</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">before</span><span class="params">(<span class="variable">$methodName</span>, <span class="variable">$callback</span>, <span class="variable">$args</span> = array<span class="params">()</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;_registerEvent(<span class="string">'before'</span>, <span class="variable">$methodName</span>, <span class="variable">$callback</span>, (<span class="keyword">array</span>) <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Register 'after' handler</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $methodName</span><br><span class="line">     * <span class="doctag">@param</span> callback $callback</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">after</span><span class="params">(<span class="variable">$methodName</span>, <span class="variable">$callback</span>, <span class="variable">$args</span> = array<span class="params">()</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;_registerEvent(<span class="string">'after'</span>, <span class="variable">$methodName</span>, <span class="variable">$callback</span>, (<span class="keyword">array</span>) <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Register 'on catch exception' handler</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $methodName</span><br><span class="line">     * <span class="doctag">@param</span> callback $callback</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onCatchException</span><span class="params">(<span class="variable">$methodName</span>, <span class="variable">$callback</span>, <span class="variable">$args</span> = array<span class="params">()</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;_registerEvent(<span class="string">'onCatchException'</span>, <span class="variable">$methodName</span>, <span class="variable">$callback</span>, (<span class="keyword">array</span>) <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Trigger event</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $eventName</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">_trigger</span><span class="params">(<span class="variable">$eventName</span>, <span class="variable">$methodName</span>, <span class="variable">$target</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$this</span>-&gt;_eventCallbacks[<span class="variable">$methodName</span>](<span class="variable">$eventName</span>))) &#123;</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$callback</span>, <span class="variable">$args</span>) = <span class="variable">$this</span>-&gt;_eventCallbacks[<span class="variable">$methodName</span>](<span class="variable">$eventName</span>);</span><br><span class="line">            <span class="variable">$args</span>[] = <span class="variable">$target</span>;</span><br><span class="line">            call_user_func_array(<span class="variable">$callback</span>, <span class="variable">$args</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Execute method</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> string $methodName</span><br><span class="line">     * <span class="doctag">@param</span> array $args</span><br><span class="line">     * <span class="doctag">@return</span> mixed</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">(<span class="variable">$methodName</span>, <span class="variable">$args</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_callable(<span class="keyword">array</span>(<span class="variable">$this</span>-&gt;_target, <span class="variable">$methodName</span>))) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="variable">$this</span>-&gt;_trigger(<span class="string">'before'</span>, <span class="variable">$methodName</span>, <span class="variable">$this</span>-&gt;_target);</span><br><span class="line">                <span class="variable">$result</span> = call_user_func_array(<span class="keyword">array</span>(<span class="variable">$this</span>-&gt;_target, <span class="variable">$methodName</span>), <span class="variable">$args</span>);</span><br><span class="line">                <span class="variable">$this</span>-&gt;_trigger(<span class="string">'after'</span>, <span class="variable">$methodName</span>, <span class="variable">$this</span>-&gt;_target);</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$result</span> ? <span class="variable">$result</span> : <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">                <span class="variable">$this</span>-&gt;_trigger(<span class="string">'onCatchException'</span>, <span class="variable">$methodName</span>, <span class="variable">$e</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="variable">$e</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Call to undefined method &#123;$this-&gt;_className&#125;::$methodName."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Get name of callback</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> callback $callback</span><br><span class="line">     * <span class="doctag">@return</span> string</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getCallbackName</span><span class="params">(<span class="variable">$callback</span>)</span></span><br><span class="line">    </span>&#123;</span><br><span class="line">        <span class="variable">$className</span>  = <span class="string">''</span>;</span><br><span class="line">        <span class="variable">$methodName</span> = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> (is_array(<span class="variable">$callback</span>) &amp;amp;&amp;amp; <span class="number">2</span> == count(<span class="variable">$callback</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_object(<span class="variable">$callback</span>[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="variable">$className</span> = get_class(<span class="variable">$callback</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$className</span> = (string) <span class="variable">$callback</span>[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$methodName</span> = (string) <span class="variable">$callback</span>[<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_string(<span class="variable">$callback</span>)) &#123;</span><br><span class="line">            <span class="variable">$methodName</span> = <span class="variable">$callback</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$className</span> . ((<span class="variable">$className</span>) ? <span class="string">'::'</span> : <span class="string">''</span>) . <span class="variable">$methodName</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這個類別有點小長，簡單說明如下：</p>
<ul>
<li><p>我們利用 Aspect::addObject() 方法來指定要被切入的物件； addObject() 方法會回傳一個透明的 Aspect 物件。</p>
</li>
<li><p>利用 before 、 after 和 onCatchException 三個方法來指定切入的時機，它們會呼叫 _registerEvent() 方法來註冊要執行的回呼函式 (callback) 。</p>
</li>
<li><p>執行原來被切入物件的方法，這時會觸動 Aspect 的 __call() 方法，並在指定的切入時機呼叫 _trigger() 方法來執行我們所切入的回呼函式。</p>
</li>
</ul>
<p>先來看看還沒有使用 AOP 前，我們對 TestClass 類別的測試：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'TestClass.php'</span>;</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> TestClass();</span><br><span class="line"><span class="comment">/* <span class="doctag">@var</span> $test TestClass */</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=======\n"</span>;</span><br><span class="line"><span class="variable">$test</span>-&gt;method1(<span class="string">'abc'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=======\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test</span>-&gt;method2(), <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=======\n"</span>;</span><br><span class="line"><span class="variable">$test</span>-&gt;method3();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=======\n"</span>;</span><br><span class="line"><span class="comment">/* 執行結果：</span><br><span class="line">=======</span><br><span class="line">TestClass::method1:</span><br><span class="line">abc</span><br><span class="line">=======</span><br><span class="line">TestClass::method2:</span><br><span class="line">2</span><br><span class="line">=======</span><br><span class="line">TestClass::method3:</span><br><span class="line">Exception: Test Exception. in TestClass.php on line 38</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
<p>接下來我們利用 Aspect 類別來對 TestClass 物件的三個方法切入 Log::save() ：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'Aspect.php'</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'TestClass.php'</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'Log.php'</span>;</span><br><span class="line"><span class="variable">$test</span> = Aspect::addObject(<span class="keyword">new</span> TestClass());</span><br><span class="line"><span class="variable">$logger</span> = <span class="keyword">new</span> Log();</span><br><span class="line"><span class="variable">$test</span>-&gt;before(<span class="string">'method1'</span>, <span class="keyword">array</span>(<span class="variable">$logger</span>, <span class="string">'save'</span>), <span class="string">'Log saved (method1).'</span>);</span><br><span class="line"><span class="variable">$test</span>-&gt;after(<span class="string">'method2'</span>, <span class="keyword">array</span>(<span class="variable">$logger</span>, <span class="string">'save'</span>), <span class="string">'Log saved (method2).'</span>);</span><br><span class="line"><span class="variable">$test</span>-&gt;onCatchException(<span class="string">'method3'</span>, <span class="keyword">array</span>(<span class="variable">$logger</span>, <span class="string">'save'</span>), <span class="string">'Log saved (method3).'</span>);</span><br><span class="line"><span class="comment">/* <span class="doctag">@var</span> $test TestClass */</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=======\n"</span>;</span><br><span class="line"><span class="variable">$test</span>-&gt;method1(<span class="string">'abc'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=======\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test</span>-&gt;method2(), <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=======\n"</span>;</span><br><span class="line"><span class="variable">$test</span>-&gt;method3();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"=======\n"</span>;</span><br><span class="line"><span class="comment">/* 執行結果：</span><br><span class="line">=======</span><br><span class="line">Log saved (method1).</span><br><span class="line">TestClass::method1:</span><br><span class="line">abc</span><br><span class="line">=======</span><br><span class="line">TestClass::method2:</span><br><span class="line">Log saved (method2).</span><br><span class="line">8</span><br><span class="line">=======</span><br><span class="line">TestClass::method3:</span><br><span class="line">Log saved (method3).</span><br><span class="line">Exception: Test Exception. in TestClass.php on line 38</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="結論">結論</h2><p>我們可以從範例看到， AOP 能幫我們在某類別的方法中插入一些額外的動作，同時又能不破壞原有類別的程式碼。而它與 Decorator 最大的不同是， Decorator 必須用很多小類別來完成相同的動作，但是 AOP 則透過 PHP 的動態特性解決了這個問題。</p>
<p>當然 AOP 也不是萬靈丹，像在本文的實作裡它就不能接觸目標類別的非公開屬性。而之前也跟 <a href="http://blog.markplace.net/" target="_blank" rel="external">Mark</a> 聊了一下，其實 AOP 偏向於程式的整體設計，所以這裡的範例尚不能用於實戰之中，僅僅只是我個人一個概念的實作而已。</p>
<p>供大家參考看看吧。也歡迎一起討論~</p>
</div><div class="tags"><a href="/tags/PHP/">PHP</a></div><div class="post-nav"><a href="/2008-05-13-build-your-own-jquery-plugin-1/" class="pre"><i class="icon-previous">[jQuery] 自製 jQuery Plugin - Part 1</i></a><a href="/2008-02-22-return-value-from-included-file/" class="next">[PHP] PHP 密技： include 與 require<i class="icon-next"></i></a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://jaceju.net"/></form></div><div class="widget"><div class="widget-title">分類</div></div><div class="widget"><div class="widget-title">標籤</div><div class="tagcloud"><a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/Web-開發/" style="font-size: 15px;">Web 開發</a> <a href="/tags/Selenium/" style="font-size: 15px;">Selenium</a> <a href="/tags/Refactoring/" style="font-size: 15px;">Refactoring</a> <a href="/tags/Laravel/" style="font-size: 15px;">Laravel</a> <a href="/tags/TDD/" style="font-size: 15px;">TDD</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/測試/" style="font-size: 15px;">測試</a> <a href="/tags/心得感想/" style="font-size: 15px;">心得感想</a> <a href="/tags/程式開發/" style="font-size: 15px;">程式開發</a> <a href="/tags/Zend-Framework/" style="font-size: 15px;">Zend Framework</a> <a href="/tags/設計模式/" style="font-size: 15px;">設計模式</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/好書推薦/" style="font-size: 15px;">好書推薦</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/ASP/" style="font-size: 15px;">ASP</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2015-11-09-php-closure-testing/">在 PHPUnit 中測試需要 closure 的函式</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-10-27-web-testing-with-phpunit-mink/">利用 PHPUnit 與 Mink 來做 Web 測試</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-10-05-simple-refatoring-example-01/">邁向 PHP 重構之路 - 以 Laravel 程式碼片段為例</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-07-29-laravel-mailcatcher/">在 Laravel 上用 MailCatcher 發送測試信件</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-07-26-laravel-events-broadcasting/">Laravel 5.1 Events Broadcasting 實務練習</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-06-10-laravel-5-1/">Laravel 5.1 正式釋出</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-06-03-selenium-on-mac/">在 Mac OS X 上搭建 Selenium 測試環境</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-05-31-skilltree-tdd-3/">自動測試與 TDD 實務開發 - 上課心得 (下)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-05-23-skilltree-tdd-2/">自動測試與 TDD 實務開發 - 上課心得 (中)</a></li><li class="post-list-item"><a class="post-list-link" href="/2015-05-17-skilltree-tdd/">自動測試與 TDD 實務開發 - 上課心得 (上)</a></li></ul></div><div class="widget"><div class="widget-title">友站連結</div><ul></ul><a href="https://www.facebook.com/91agile/" title="91 敏捷開發之路" target="_blank">91 敏捷開發之路</a><ul></ul><a href="https://dotblogs.com.tw/hatelove/archive/2013/01/11/learning-tdd-in-30-days-catalog-and-reference.aspx" title="30天快速上手TDD by 91" target="_blank">30天快速上手TDD by 91</a></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">網站製作學習誌.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>